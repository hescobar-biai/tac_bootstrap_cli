# EntitySpec Domain Model for Entity Generation

**ADW ID:** feature_2_1
**Date:** 2026-01-23
**Specification:** specs/issue-140-adw-feature_2_1-sdlc_planner-entity-spec-domain-model.md

## Overview

This feature introduces domain models that describe entities to be generated by TAC Bootstrap CLI. The `EntitySpec` model serves as a typed contract between the CLI, wizard interface, and code generation system, enabling the CLI to generate complete CRUD entities following vertical slice architecture with comprehensive validation and naming convention enforcement.

## What Was Built

- **FieldType Enum**: Defines 9 supported database field types (STRING, INTEGER, FLOAT, BOOLEAN, DATETIME, UUID, TEXT, DECIMAL, JSON)
- **FieldSpec Model**: Represents individual entity fields with validation for naming conventions, Python keywords, and SQLAlchemy conflicts
- **EntitySpec Model**: Represents complete entity specifications with PascalCase/kebab-case validation, reserved field name protection, and derived name generation
- **Domain Package Integration**: Updated domain module exports to include new entity configuration models
- **Comprehensive Test Suite**: 761 lines of unit tests covering all validation rules, edge cases, and property derivations

## Technical Implementation

### Files Modified

- `tac_bootstrap_cli/tac_bootstrap/domain/entity_config.py`: Core domain models (409 lines) with Pydantic v2 validators and comprehensive docstrings
- `tac_bootstrap_cli/tac_bootstrap/domain/__init__.py`: Updated exports to include EntitySpec, FieldSpec, and FieldType
- `tac_bootstrap_cli/tests/test_entity_config.py`: Complete unit test suite (761 lines) covering all validation scenarios

### Key Changes

1. **FieldType Enum**: String-based enum with 9 database field types, each with clear documentation about database mapping and usage

2. **FieldSpec Validation**:
   - Snake_case pattern validation using regex (`^[a-z][a-z0-9_]*$`)
   - Python keyword rejection using `keyword.iskeyword()`
   - SQLAlchemy conflict detection (query, metadata, registry, mapper)
   - Clear error messages for each validation failure

3. **EntitySpec Validation**:
   - PascalCase name validation with minimum 2 characters (`^[A-Z][a-zA-Z0-9]*$`)
   - Kebab-case capability validation (`^[a-z][a-z0-9]*(-[a-z0-9]+)*$`)
   - Reserved field name protection (id, state, version, created_at, updated_at)
   - Non-empty field list validation

4. **Derived Name Properties**:
   - `snake_name`: Converts PascalCase to snake_case (Product → product, UserProfile → user_profile)
   - `plural_name`: Rule-based pluralization (Product → products, Quiz → quizzes, Box → boxes)
   - `table_name`: Database table name (returns plural_name)

5. **Module Constants**:
   - `RESERVED_FIELD_NAMES`: Tuple of BaseEntity fields
   - `SQLALCHEMY_CONFLICTS`: Tuple of problematic attribute names
   - Pattern regex constants for validation

## How to Use

### Basic Entity Definition

```python
from tac_bootstrap.domain.entity_config import EntitySpec, FieldSpec, FieldType

# Define a simple entity
product = EntitySpec(
    name="Product",
    capability="catalog",
    fields=[
        FieldSpec(
            name="title",
            field_type=FieldType.STRING,
            required=True,
            max_length=200
        ),
        FieldSpec(
            name="price",
            field_type=FieldType.DECIMAL,
            required=True
        ),
        FieldSpec(
            name="description",
            field_type=FieldType.TEXT,
            required=False
        )
    ],
    authorized=True,
    async_mode=True
)

# Access derived names
print(product.snake_name)    # "product"
print(product.plural_name)   # "products"
print(product.table_name)    # "products"
```

### Field Specification Options

```python
# String field with max length
email_field = FieldSpec(
    name="email_address",
    field_type=FieldType.STRING,
    required=True,
    unique=True,
    indexed=True,
    max_length=255,
    description="User's primary email address"
)

# Boolean field with default
is_active_field = FieldSpec(
    name="is_active",
    field_type=FieldType.BOOLEAN,
    required=False,
    default=True,
    description="Whether the record is active"
)

# JSON field
metadata_field = FieldSpec(
    name="custom_metadata",
    field_type=FieldType.JSON,
    required=False,
    description="Additional structured data"
)
```

### Entity Configuration Options

```python
# Entity with authentication
authenticated_entity = EntitySpec(
    name="UserProfile",
    capability="user-management",
    fields=[...],
    authorized=True,      # Generate with auth templates
    async_mode=False,     # Use sync repository
    with_events=False     # No domain events
)

# Entity with async and events
event_driven_entity = EntitySpec(
    name="OrderStatus",
    capability="orders",
    fields=[...],
    authorized=True,
    async_mode=True,      # Use async repository pattern
    with_events=True      # Generate domain event support
)
```

### Serialization for Configuration Files

```python
# Serialize to dict
entity_dict = product.model_dump()

# Serialize to JSON
entity_json = product.model_dump_json(indent=2)

# Deserialize from dict
entity = EntitySpec(**entity_dict)

# Deserialize from JSON
import json
entity = EntitySpec(**json.loads(entity_json))
```

## Configuration

### Field Type Mapping

| FieldType    | Python Type | Database Type           | Notes                           |
|--------------|-------------|-------------------------|----------------------------------|
| STRING       | str         | VARCHAR                 | Use max_length for size         |
| INTEGER      | int         | INTEGER/INT             | Standard integer                |
| FLOAT        | float       | FLOAT/DOUBLE            | Floating-point number           |
| BOOLEAN      | bool        | BOOLEAN/BIT             | True/False flag                 |
| DATETIME     | datetime    | TIMESTAMP               | Timezone-aware timestamp        |
| UUID         | UUID        | UUID                    | Universally unique identifier   |
| TEXT         | str         | TEXT/CLOB               | Large text field                |
| DECIMAL      | Decimal     | DECIMAL/NUMERIC         | Fixed-precision decimal         |
| JSON         | dict/list   | JSON/JSONB              | JSON data structure             |

### Reserved Field Names

Cannot be used as field names (provided by BaseEntity):
- `id` - Primary key
- `state` - Entity state tracking
- `version` - Optimistic locking
- `created_at` - Creation timestamp
- `updated_at` - Last update timestamp

### SQLAlchemy Conflicts

Cannot be used as field names (conflict with SQLAlchemy):
- `query` - Query builder attribute
- `metadata` - Table metadata
- `registry` - Mapper registry
- `mapper` - Object mapper

### Naming Conventions

- **Entity name**: PascalCase, min 2 chars (Product, OAuth2Client, UserProfile)
- **Capability**: kebab-case (catalog, user-management, api-gateway)
- **Field name**: snake_case (user_name, email_address, is_active)

### Pluralization Rules

- Words ending in 'z': double z and append 'es' (quiz → quizzes)
- Words ending in 's', 'x', 'ch', 'sh': append 'es' (box → boxes, branch → branches)
- Other words: append 's' (product → products, category → categorys)

## Testing

Run the entity configuration tests:

```bash
# Test entity_config module only
cd tac_bootstrap_cli && uv run pytest tests/test_entity_config.py -v

# Test with coverage
cd tac_bootstrap_cli && uv run pytest tests/test_entity_config.py -v --cov=tac_bootstrap.domain.entity_config

# Run all domain tests
cd tac_bootstrap_cli && uv run pytest tests/ -v -k "entity"
```

### Test Coverage

The test suite includes 761 lines covering:
- All FieldType enum values and serialization
- FieldSpec validation (valid snake_case, Python keywords, SQLAlchemy conflicts, invalid patterns)
- EntitySpec validation (PascalCase, kebab-case, reserved fields, empty lists)
- Property derivations (snake_name, plural_name, table_name) with edge cases
- JSON/YAML serialization round-trips
- Clear error messages for all validation failures

## Notes

### Design Decisions

1. **Pluralization**: Simple rule-based approach avoids complex natural language processing. Edge cases like "Person" → "People" are rare in domain modeling and can be handled via future custom configuration if needed.

2. **Default Value Validation**: No type checking at Pydantic level. Complex validation (datetime strings vs objects, JSON serialization) is deferred to database/ORM layer.

3. **PascalCase Support**: Pattern allows internal numbers (OAuth2Client, Product2) for realistic entity names.

4. **SQLAlchemy Conflicts**: Small curated list prevents hard-to-debug runtime errors. Can be expanded based on feedback.

5. **Optional Fields**: Entities can have all optional fields - valid for configuration objects and user preferences. BaseEntity provides required fields (id, etc.).

### Future Enhancements

- Custom pluralization rules for irregular nouns (person → people)
- Relationship field types (ForeignKey, ManyToMany)
- Field-level validation rules (regex patterns, min/max values)
- Database dialect-specific type mappings
- Custom table name overrides
- Composite unique constraints
- Index definitions (single and composite)

### Integration Points

This domain model is designed to integrate with:
- **CLI**: `generate entity` command will use EntitySpec for user input
- **Wizard**: Interactive entity builder will construct EntitySpec instances
- **Templates**: Jinja2 templates will receive EntitySpec for code generation
- **Configuration**: EntitySpec can be serialized to YAML/JSON for project config files
