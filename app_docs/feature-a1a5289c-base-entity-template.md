# Base Entity Template for Domain Models

**ADW ID:** a1a5289c
**Date:** 2026-01-22
**Specification:** specs/issue-111-adw-a1a5289c-sdlc_planner-template-base-entity.md

## Overview

This feature implements a comprehensive base entity template that provides audit trail, soft delete, state management, and optimistic locking for all domain entities generated by TAC Bootstrap CLI. The template eliminates 50+ lines of boilerplate code per entity while ensuring consistency across all domain models.

## What Was Built

- **EntityState IntEnum**: State machine with three states (INACTIVE=0, ACTIVE=1, DELETED=2)
- **Entity Base Class**: Pydantic-based foundation with 15+ fields covering identity, audit trail, metadata, and lifecycle
- **Lifecycle Methods**: activate(), deactivate(), delete(), restore() with audit tracking
- **Query Methods**: is_active(), is_deleted(), is_inactive() for state checking
- **Version Management**: Optimistic locking with automatic version incrementing
- **Multi-tenancy Support**: organization_id and project_id fields for tenant isolation
- **Template & Implementation**: Both Jinja2 template (.j2) and rendered Python file for immediate use

## Technical Implementation

### Files Modified

- `tac_bootstrap_cli/tac_bootstrap/templates/shared/base_entity.py.j2`: Jinja2 template (388 lines) for generating base entity in target projects
- `src/shared/domain/base_entity.py`: Rendered implementation of the template for use within tac_bootstrap itself
- `src/shared/__init__.py`: Package initialization for shared kernel
- `src/shared/domain/__init__.py`: Domain package exports for Entity and EntityState
- `specs/issue-111-adw-a1a5289c-sdlc_planner-template-base-entity.md`: Complete specification with implementation plan
- `specs/issue-111-adw-a1a5289c-sdlc_planner-template-base-entity-checklist.md`: Review checklist for validation

### Key Changes

**EntityState Enum**
- IntEnum-based state machine with three explicit states
- Enables database-efficient integer storage while maintaining semantic clarity
- Supports state-based filtering and lifecycle transitions

**Entity Base Class Structure**
- **Identity Fields**: id (UUID), code (business identifier), name, description, type
- **Audit Trail**: created_at, created_by, updated_at, updated_by with automatic timestamp management
- **State Management**: state field with lifecycle methods for transitions
- **Versioning**: version field with mark_updated() for optimistic locking
- **Multi-tenancy**: organization_id, project_id, owner for tenant isolation
- **Validation**: ConfigDict with validate_assignment=True ensures field mutations are validated

**IDK Documentation Pattern**
- All classes and methods include comprehensive IDK (Invariants-Dependencies-Knowledge) docstrings
- Documents responsibilities, invariants, collaborators, failure modes, and related documentation
- Follows standards from `ai_docs/doc/create-crud-entity/DOCUMENTATION_STANDARDS.md`

**Lifecycle Methods**
- `deactivate(user_id)`: Transitions to INACTIVE state, updates audit fields
- `activate(user_id)`: Transitions to ACTIVE state, restores from inactive
- `delete(user_id)`: Soft delete to DELETED state (preserves data)
- `mark_updated(user_id)`: Increments version, updates timestamp/user

**Validator Integration**
- `sync_updated_at` field validator ensures updated_at stays synchronized with mutations
- Pydantic's validate_assignment ensures all state changes trigger validation

## How to Use

### For Generated Projects

When TAC Bootstrap generates a new project, the base_entity.py.j2 template will be rendered to create a foundation entity class:

1. **Create a Domain Entity**:
```python
from src.shared.domain import Entity, EntityState

class Product(Entity):
    """Product entity with inventory tracking."""
    sku: str
    price: float
    stock_quantity: int = 0

    # Entity base provides: id, code, name, description, type,
    # created_at/by, updated_at/by, state, version, etc.
```

2. **Use Lifecycle Methods**:
```python
product = Product(
    code="PROD-001",
    name="Laptop",
    sku="LAP-HP-001",
    price=999.99
)

# State transitions with audit trail
product.activate(user_id="user-123")
assert product.is_active()

product.deactivate(user_id="user-123")
assert product.is_inactive()

product.delete(user_id="user-123")
assert product.is_deleted()
```

3. **Version Management**:
```python
# Optimistic locking pattern
product.mark_updated(user_id="user-456")
# version increments from 1 to 2, updated_at refreshed
```

### For TAC Bootstrap Development

The rendered `src/shared/domain/base_entity.py` is immediately available for use in tac_bootstrap itself:

```python
from src.shared.domain import Entity, EntityState

class TemplateConfig(Entity):
    """Configuration for template generation."""
    template_path: str
    variables: dict[str, Any]
```

## Configuration

### Template Variables

The template is currently **static** (no Jinja2 variables). Future versions may support:
- `{{ config.project.name }}`: Project name for custom docstrings
- `{{ config.features.soft_delete }}`: Toggle soft delete functionality
- `{{ config.features.multi_tenancy }}`: Toggle organization_id/project_id fields

### Field Customization

When inheriting from Entity, you can:
- Override default values (e.g., `state: int = EntityState.INACTIVE`)
- Add domain-specific fields
- Extend lifecycle methods while calling super()
- Customize __str__ and __repr__ representations

## Testing

### Import Validation
```bash
python -c "from src.shared.domain.base_entity import Entity, EntityState; print('Import successful')"
```

### State Transition Testing
```python
from src.shared.domain import Entity

entity = Entity(code="TEST-001", name="Test Entity")
assert entity.is_active()  # Default state is ACTIVE

entity.deactivate(user_id="test-user")
assert entity.is_inactive()
assert entity.updated_by == "test-user"

entity.activate(user_id="test-user")
assert entity.is_active()

entity.delete(user_id="test-user")
assert entity.is_deleted()
```

### Version Management Testing
```python
entity = Entity(code="TEST-002", name="Version Test")
initial_version = entity.version  # Should be 1

entity.mark_updated(user_id="test-user")
assert entity.version == initial_version + 1
assert entity.updated_by == "test-user"
```

### Full Validation Suite
```bash
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short
cd tac_bootstrap_cli && uv run ruff check .
cd tac_bootstrap_cli && uv run mypy tac_bootstrap/
cd tac_bootstrap_cli && uv run tac-bootstrap --help
```

## Architecture

### Design Patterns

**Domain-Driven Design**
- Entity follows DDD aggregate root pattern
- Encapsulates identity, validation, and lifecycle
- Enforces invariants through Pydantic validation

**State Machine Pattern**
- EntityState enum defines valid states
- Lifecycle methods manage state transitions
- Query methods enable state-based logic

**Optimistic Locking**
- version field tracks entity modifications
- Enables conflict detection in concurrent updates
- Applications can implement version-based conflict resolution

### Integration Points

**Pydantic BaseModel**
- Automatic validation of all fields
- JSON serialization/deserialization
- Type safety and IDE autocomplete

**Database Persistence**
- Maps cleanly to SQL tables via SQLAlchemy or similar ORMs
- state field enables efficient soft-delete queries
- Audit fields support compliance and debugging

**Multi-tenancy**
- organization_id enables tenant-level data isolation
- project_id provides sub-tenant scoping
- owner field supports user-level ownership

## Notes

### Implementation Approach
- Template is based on reference implementation in `ai_docs/doc/create-crud-entity/shared/base_entity.py.md`
- Current version is a **static template** (no Jinja2 parameterization)
- Template and rendered file are identical (dogfooding pattern)

### IDK Documentation Standard
- All docstrings follow the IDK pattern: Invariants, Dependencies, Knowledge
- Provides comprehensive context for AI agents and human developers
- Documents responsibilities, state, collaborators, failure modes, and related docs

### Future Enhancements
- Add Jinja2 variables for project-specific customization
- Support optional fields via feature flags in config.yml
- Generate SQLAlchemy/Tortoise ORM mixins from the base entity
- Add event sourcing hooks (on_created, on_updated, on_deleted)
- Support custom state enums for domain-specific lifecycles

### Related Documentation
- `ai_docs/doc/create-crud-entity/shared/base_entity.py.md`: Reference implementation (400+ lines)
- `ai_docs/doc/create-crud-entity/DOCUMENTATION_STANDARDS.md`: IDK docstring standards
- `specs/issue-111-adw-a1a5289c-sdlc_planner-template-base-entity.md`: Complete specification

### Edge Cases Handled
- Idempotent state transitions (activating already-active entity is safe)
- Version increment on every mark_updated() call
- Automatic timestamp synchronization via validators
- Minimal required fields (only code and name are mandatory)
- Optional multi-tenancy and audit fields support various architectures
