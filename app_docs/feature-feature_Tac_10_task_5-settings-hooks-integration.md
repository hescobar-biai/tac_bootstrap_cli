---
doc_type: feature
adw_id: feature_Tac_10_task_5
date: 2026-01-26
idk:
  - hooks
  - logging
  - context-tracking
  - jinja2-templates
  - settings-configuration
  - universal-hook-logger
  - context-bundle-builder
  - claude-code
tags:
  - feature
  - infrastructure
  - monitoring
  - configuration
related_code:
  - .claude/settings.json
  - tac_bootstrap_cli/tac_bootstrap/templates/claude/settings.json.j2
  - .claude/hooks/universal_hook_logger.py
  - .claude/hooks/context_bundle_builder.py
---

# Settings Hooks Integration with Universal Logger and Context Builder

**ADW ID:** feature_Tac_10_task_5
**Date:** 2026-01-26
**Specification:** specs/issue-310-adw-feature_Tac_10_task_5-sdlc_planner-update-settings-hooks-integration.md

## Overview

This feature integrates comprehensive logging and context tracking into the TAC Bootstrap hooks system by adding `universal_hook_logger` and `context_bundle_builder` to all relevant Claude Code hook events. This provides centralized event logging for debugging, auditing workflows, and maintaining session context across file operations.

## What Was Built

- **Enhanced Hook Integration**: All 9 Claude Code hooks now execute universal logging before their specific scripts
- **Context Tracking**: File operations (Read, Write) are automatically tracked for context recovery
- **Dual Implementation**: Changes applied to both runtime `.claude/settings.json` and template `settings.json.j2`
- **Package Manager Abstraction**: Template uses Jinja2 variables for multi-package-manager support

## Technical Implementation

### Files Modified

- `.claude/settings.json`: Runtime hooks configuration with integrated logging
  - Modified PreToolUse, PostToolUse, Stop, Notification, SubagentStop, PreCompact, UserPromptSubmit
  - Added SessionStart and SessionEnd hooks

- `tac_bootstrap_cli/tac_bootstrap/templates/claude/settings.json.j2`: Template for generated projects
  - Identical hook structure using `{{ config.project.package_manager.value }}` variable
  - Added all 9 hooks with universal logger integration

### Key Changes

1. **Command Chaining**: Hooks now use `&&` to chain `universal_hook_logger` before original scripts, ensuring sequential execution and event identification

2. **Event Identification**: Each logger call includes `--event <HookName>` parameter for precise event tracking in JSONL logs

3. **Context Bundle Builder Integration**:
   - UserPromptSubmit: Uses `--type user_prompt` to track prompt submissions
   - PostToolUse: Uses `--type post_tool_use --matcher "Read|Write"` to track file operations

4. **New Session Hooks**: Added SessionStart and SessionEnd hooks that execute only universal_hook_logger for session lifecycle tracking

5. **Error Handling**: All hooks maintain `|| true` suffix to prevent logging failures from blocking user workflows

## How to Use

The hooks system activates automatically when using Claude Code in the TAC Bootstrap repository or in projects generated by the CLI.

### For TAC Bootstrap Development

The hooks are already configured in `.claude/settings.json` and will execute on:
- **PreToolUse**: Before any tool execution (Bash, Read, Write, etc.)
- **PostToolUse**: After tool execution, tracking Read/Write operations
- **UserPromptSubmit**: When user submits a prompt
- **Stop**: When stopping a conversation
- **Notification**: On system notifications
- **SubagentStop**: When subagent stops
- **PreCompact**: Before context compaction
- **SessionStart**: At session initialization
- **SessionEnd**: At session termination

### For Generated Projects

When generating a new project with `tac-bootstrap`, the `settings.json.j2` template automatically includes all hooks with the correct package manager command (uv, npm, etc.):

```bash
tac-bootstrap generate --config config.yml
```

The generated `.claude/settings.json` will have all hooks configured with the project's package manager.

## Configuration

### Hook Logs Location

Logs are written by `universal_hook_logger.py` to:
- `.claude/logs/hooks/<event_name>_<timestamp>.jsonl`

### Context Bundles Location

Context bundles are created by `context_bundle_builder.py` in:
- `.claude/context_bundles/<bundle_type>_<timestamp>.json`

### Package Manager Support

The template supports any package manager via the Jinja2 variable:
```json
"{{ config.project.package_manager.value }}"
```

Supported values: `uv`, `npm`, `yarn`, `pnpm`, `poetry`, etc.

## Testing

### Validate JSON Syntax

```bash
python -m json.tool .claude/settings.json > /dev/null && echo "Valid JSON"
```

### Run Unit Tests

```bash
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short
```

### Lint and Type Check

```bash
cd tac_bootstrap_cli && uv run ruff check .
cd tac_bootstrap_cli && uv run mypy tac_bootstrap/
```

### CLI Smoke Test

```bash
cd tac_bootstrap_cli && uv run tac-bootstrap --help
```

### Verify Hook Execution

Hooks execute automatically during Claude Code sessions. Check logs after any tool use:

```bash
ls -ltr .claude/logs/hooks/
cat .claude/logs/hooks/PreToolUse_*.jsonl | tail -1 | jq .
```

## Notes

### Design Decisions

1. **Chaining vs Separate Hooks**: Command chaining with `&&` was chosen to guarantee execution order and simplify configuration over multiple hook entries

2. **Event Identification**: The `--event <HookName>` parameter enables precise filtering and analysis of JSONL logs by event type

3. **Context Bundle Builder Replacement**: UserPromptSubmit now uses `context_bundle_builder` instead of `user_prompt_submit.py --log-only` for improved context tracking

4. **Template Abstraction**: Using Jinja2 variables ensures generated projects work with any package manager without manual configuration

5. **Fail-Safe Design**: All hooks end with `|| true` to ensure logging failures never interrupt user workflows

### Monitoring and Debugging

To debug hook execution issues:

```bash
# Check recent hook logs
tail -f .claude/logs/hooks/*.jsonl

# Filter by event type
grep '"event":"PreToolUse"' .claude/logs/hooks/*.jsonl | jq .

# View context bundles
ls -ltr .claude/context_bundles/
cat .claude/context_bundles/user_prompt_*.json | jq .
```

### Future Considerations

- Evaluate adding `SessionResume` hook when Claude Code supports it
- Consider adding `--verbose` flag to universal_hook_logger for enhanced debugging
- Potential configuration for log output paths (currently hardcoded in scripts)
- Explore log rotation and archival strategies for long-running projects
