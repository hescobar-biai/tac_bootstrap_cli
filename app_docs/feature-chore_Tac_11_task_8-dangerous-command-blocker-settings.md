---
doc_type: feature
adw_id: chore_Tac_11_task_8
date: 2026-01-27
idk:
  - settings-template
  - hooks
  - dangerous-command-blocker
  - security
  - bash-validation
  - pretooluse
tags:
  - feature
  - security
  - template
related_code:
  - tac_bootstrap_cli/tac_bootstrap/templates/claude/settings.json.j2
  - tac_bootstrap_cli/tac_bootstrap/templates/claude/hooks/dangerous_command_blocker.py.j2
  - tac_bootstrap_cli/tests/test_new_tac10_templates.py
---

# Dangerous Command Blocker Integration in Settings Template

**ADW ID:** chore_Tac_11_task_8
**Date:** 2026-01-27
**Specification:** specs/issue-361-adw-chore_Tac_11_task_8-sdlc_planner-update-settings-dangerous-blocker.md

## Overview

Integrated the dangerous command blocker hook into the settings.json.j2 template, ensuring all projects generated by TAC Bootstrap CLI include built-in protection against dangerous Bash commands like `rm -rf`, `dd`, `mkfs`, and `chmod 777` from the start.

## What Was Built

- Added PreToolUse hook entry with Bash matcher in settings.json.j2 template
- Configured dangerous_command_blocker.py to run before other hooks with 5-second timeout
- Added comprehensive test coverage for the new hook configuration
- Validated hook structure, matcher configuration, and timeout settings

## Technical Implementation

### Files Modified

- `tac_bootstrap_cli/tac_bootstrap/templates/claude/settings.json.j2`: Added new PreToolUse hook entry with Bash matcher that executes dangerous_command_blocker.py with 5000ms timeout
- `tac_bootstrap_cli/tests/test_new_tac10_templates.py`: Added test assertions to verify dangerous_command_blocker presence, Bash matcher configuration, and timeout value

### Key Changes

1. **PreToolUse Hook Structure**: Added a new hook entry before the existing universal hooks, specifically targeting Bash tool invocations with a "Bash" matcher

2. **Hook Configuration**: The blocker uses the project's package manager variable (`{{ config.project.package_manager.value }}`) to execute the dangerous_command_blocker.py script from the `.claude/hooks/` directory

3. **Timeout Setting**: Configured with a 5-second (5000ms) timeout to ensure quick validation without blocking legitimate commands

4. **Test Coverage**: Enhanced test suite with helper function `get_all_hook_commands()` to handle multiple PreToolUse entries, and added specific assertions for blocker presence, matcher type, and timeout configuration

## How to Use

The dangerous command blocker is automatically integrated into all new projects generated by TAC Bootstrap CLI. When a project is created:

1. Generate a new project using the CLI:
```bash
cd tac_bootstrap_cli && uv run tac-bootstrap init my-project
```

2. The generated project will have the dangerous command blocker active in `.claude/settings.json`

3. When Claude attempts to run dangerous Bash commands, the hook will intercept and block them automatically

4. Developers can review blocked commands in hook logs and modify the blocker patterns in `.claude/hooks/dangerous_command_blocker.py` if needed

## Configuration

The hook is configured in the settings template with these parameters:

- **Matcher**: `"Bash"` - Only intercepts Bash tool invocations
- **Command**: Uses the project's package manager (uv/npm/yarn) to execute the blocker script
- **Timeout**: 5000ms (5 seconds) - Ensures fast validation
- **Path**: `$CLAUDE_PROJECT_DIR/.claude/hooks/dangerous_command_blocker.py`

The dangerous_command_blocker.py script contains patterns for blocking:
- Recursive deletions (`rm -rf`, `rm -r`)
- Disk operations (`dd`, `mkfs`)
- Permission changes (`chmod 777`, `chmod -R 777`)
- System modifications (`shutdown`, `reboot`)
- And other potentially destructive commands

## Testing

Run the full test suite to verify the integration:

```bash
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short
```

Test specifically for dangerous command blocker configuration:

```bash
cd tac_bootstrap_cli && uv run pytest tests/test_new_tac10_templates.py::TestSettingsTemplateWithHooks -v
```

Verify linting passes:

```bash
cd tac_bootstrap_cli && uv run ruff check .
```

Run smoke test to ensure CLI works:

```bash
cd tac_bootstrap_cli && uv run tac-bootstrap --help
```

## Notes

- The dangerous_command_blocker.py template already existed; this change only integrates it into the settings template
- The hook is positioned as the first PreToolUse entry to catch dangerous commands before any other processing
- Exit codes: 0 (allow command), 2 (block command)
- The blocker handles tool filtering internally by checking if `tool_name == 'Bash'`
- Multiple PreToolUse hook entries are supported; the Bash matcher entry runs only for Bash tool calls, while the empty matcher entry runs for all tools
