# Feature: CLI Expert Expertise File

## Metadata
issue_number: `568`
adw_id: `feature_Tac_13_Task_6`
issue_json: `{"number": 568, "title": "[TAC-13] Task 6: Create CLI expert - expertise file", "body": "**Workflow Metadata:**\n```\n/feature\n/adw_sdlc_zte_iso\n/adw_id: feature_Tac_13_Task_6\n```\n\n**Description:**\nCreate initial expertise.yaml seed template and populate for repo root by running self-improve.\n\n**Technical Steps:**\n\n#### A) Create Seed Template in CLI\n\n1. **Create empty seed template**:\n\n   **File**: `/Users/hernandoescobar/Documents/Celes/tac_bootstrap/tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/experts/cli/expertise.yaml.j2`\n\n   **Seed Content**:\n   ```yaml\n   overview:\n     description: \"{{ config.project.name }} CLI and code generation system\"\n     key_files: []\n     total_files: 0\n     last_updated: \"{{ '{{' }} now().strftime('%Y-%m-%d') {{ '}}' }}\"\n\n   core_implementation:\n     # To be populated by self-improve\n\n   key_operations:\n     # To be populated by self-improve\n\n   best_practices:\n     # To be populated by self-improve\n   ```\n\n2. **Register template in scaffold_service.py**:\n   ```python\n   # TAC-13: CLI Expert Expertise Seed\n   plan.add_file(\n       action=\"skip_if_exists\",  # Don't overwrite if exists\n       template=\"claude/commands/experts/cli/expertise.yaml.j2\",\n       path=\".claude/commands/experts/cli/expertise.yaml\",\n       reason=\"CLI expert expertise seed file\"\n   )\n   ```\n\n#### B) Populate Expertise in Repo Root\n\n1. **Create empty file**:\n   ```bash\n   touch /Users/hernandoescobar/Documents/Celes/tac_bootstrap/.claude/commands/experts/cli/expertise.yaml\n   ```\n\n2. **Execute self-improve to populate**:\n   ```bash\n   cd /Users/hernandoescobar/Documents/Celes/tac_bootstrap\n   /experts:cli:self-improve false\n   ```\n\n3. **Expert should document**:\n   - CLI structure: `tac_bootstrap_cli/tac_bootstrap/`\n   - Domain models: `domain/` (Config, Project, CommandConfig)\n   - Application services: `application/scaffold_service.py`\n   - Infrastructure: `infrastructure/` (template rendering, filesystem)\n   - Interfaces: `interfaces/cli.py` (Typer commands)\n   - Templates: `templates/` organization\n   - Key operations with file paths"}`

## Feature Description

This feature implements the CLI Expert's expertise file system, completing the Act → Learn → Reuse loop by creating a seed template that can be deployed to new projects and populating the expertise file in the tac_bootstrap repo root.

The expertise file serves as the CLI Expert's "mental model" - a structured YAML file (max 1000 lines) that captures patterns, architecture, and key knowledge about the tac_bootstrap CLI system. This enables the expert to maintain knowledge across sessions and provide informed answers without re-reading the entire codebase.

## User Story

As a CLI expert agent
I want to maintain a populated expertise.yaml file that documents the tac_bootstrap CLI architecture
So that I can answer questions efficiently using my mental model and continuously improve my understanding through the self-improve workflow

## Problem Statement

The CLI Expert currently has question and self-improve prompts (Tasks 4 & 5) but lacks the expertise.yaml file they operate on. Without this file:
- The question prompt cannot read expertise to answer queries efficiently
- The self-improve workflow has no file to validate and update
- New projects generated by tac-bootstrap won't have the seed template
- The Act → Learn → Reuse loop is incomplete

## Solution Statement

Implement a dual-strategy approach:
1. **Template Strategy (Strategy A)**: Create a Jinja2 template seed file that deploys to new projects with placeholder structure
2. **Registration Strategy (Strategy B)**: Register the template in scaffold_service.py with `skip_if_exists` action to preserve learning
3. **Implementation Strategy**: Execute self-improve in repo root to populate the expertise file with real CLI knowledge

This follows the TAC-13 dual strategy pattern where templates work as both generation artifacts and fully populated reference implementations.

## Relevant Files

### Existing Files (To Modify)
- `tac_bootstrap_cli/tac_bootstrap/application/scaffold_service.py` - Add template registration in `_add_claude_files()` method around line 483-499
- `.claude/commands/experts/cli/self-improve.md` - The 7-phase workflow that will populate expertise

### New Files (To Create)
- `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/experts/cli/expertise.yaml.j2` - Jinja2 seed template
- `.claude/commands/experts/cli/expertise.yaml` - Populated expertise file in repo root (generated by self-improve)

## Implementation Plan

### Phase 1: Create Seed Template
Create the Jinja2 template that will be deployed to new projects as a starting point for CLI experts.

**Deliverable**: `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/experts/cli/expertise.yaml.j2`

### Phase 2: Register Template
Add template registration to scaffold_service.py using `skip_if_exists` action to preserve expertise learning between regenerations.

**Deliverable**: Updated `scaffold_service.py` with expertise file registration

### Phase 3: Populate Expertise in Repo Root
Execute the self-improve workflow to populate the expertise file with actual CLI architecture knowledge.

**Deliverable**: `.claude/commands/experts/cli/expertise.yaml` with <1000 lines of CLI knowledge

## Step by Step Tasks

### Task 1: Create Jinja2 Seed Template

Create the seed template file that will deploy to new projects:

1. Create file: `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/experts/cli/expertise.yaml.j2`

2. Content should include:
   - `overview` section with project.name from config, empty key_files list, total_files: 0
   - `last_updated` using Jinja2 date generation: `"{{ '{{' }} now().strftime('%Y-%m-%d') {{ '}}' }}"`
   - `core_implementation` section with comment: `# To be populated by self-improve`
   - `key_operations` section with comment: `# To be populated by self-improve`
   - `best_practices` section with comment: `# To be populated by self-improve`

3. Use proper Jinja2 escaping for the nested template variable (double curly braces need escaping)

4. Keep template minimal - this is a seed, not a reference implementation

### Task 2: Register Template in Scaffold Service

Update scaffold_service.py to register the expertise template:

1. Open `tac_bootstrap_cli/tac_bootstrap/application/scaffold_service.py`

2. Locate the `_add_claude_files()` method, specifically the expert_commands list around line 483-499

3. Add template registration AFTER the existing expert command registrations:
   ```python
   # TAC-13 Task 6: CLI Expert Expertise Seed
   plan.add_file(
       action="skip_if_exists",  # Don't overwrite if exists
       template="claude/commands/experts/cli/expertise.yaml.j2",
       path=".claude/commands/experts/cli/expertise.yaml",
       reason="CLI expert expertise seed file"
   )
   ```

4. Use `FileAction.SKIP_IF_EXISTS` (not CREATE) to preserve learning across regenerations

5. Add comment referencing TAC-13 Task 6 for traceability

### Task 3: Create Empty Expertise File in Repo Root

Prepare the file that will be populated by self-improve:

1. Create directory if needed: `mkdir -p .claude/commands/experts/cli/`

2. Create empty file: `touch .claude/commands/experts/cli/expertise.yaml`

3. Verify file exists and is writable

### Task 4: Execute Self-Improve to Populate Expertise

Run the self-improve workflow to populate the expertise file:

1. Execute the CLI expert self-improve command:
   ```bash
   cd /Users/hernandoescobar/Documents/Celes/tac_bootstrap
   # Run with check_git_diff=false to do full analysis
   /experts:cli:self-improve false
   ```

2. The self-improve workflow (7 phases) will:
   - Read the empty expertise file
   - Validate against the actual CLI codebase
   - Document CLI structure, domain models, services, infrastructure
   - Document key operations with file paths
   - Document best practices and patterns
   - Enforce <1000 line limit
   - Validate YAML syntax

3. Expected sections to be populated:
   - **overview**: Description of tac_bootstrap CLI, key files list, total file count
   - **core_implementation**: Domain models (Config, Project, etc.), application services, infrastructure, interfaces
   - **key_operations**: Template rendering, scaffold planning, file operations, CLI commands
   - **best_practices**: DDD patterns, Jinja2 conventions, validation patterns

4. Verify output file has valid YAML and is under 1000 lines:
   ```bash
   wc -l .claude/commands/experts/cli/expertise.yaml
   python -c "import yaml; yaml.safe_load(open('.claude/commands/experts/cli/expertise.yaml'))"
   ```

### Task 5: Validation Commands

Run all validation commands to ensure no regressions:

```bash
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short
cd tac_bootstrap_cli && uv run ruff check .
cd tac_bootstrap_cli && uv run mypy tac_bootstrap/
cd tac_bootstrap_cli && uv run tac-bootstrap --help
```

## Testing Strategy

### Unit Tests

No new unit tests required for this task - the expertise file is data, not code.

### Integration Testing

1. **Template Generation Test**: Verify seed template deploys correctly to new projects
   ```bash
   cd tac_bootstrap_cli
   uv run tac-bootstrap wizard --test-output /tmp/test-expertise
   # Verify /tmp/test-expertise/.claude/commands/experts/cli/expertise.yaml exists and has seed structure
   ```

2. **Self-Improve Test**: Verify self-improve can read and update expertise
   ```bash
   /experts:cli:self-improve false
   # Should complete without errors
   # Should produce valid YAML
   # Should be under 1000 lines
   ```

3. **Question Prompt Test**: Verify question prompt can read expertise
   ```bash
   /experts:cli:question "Where are templates registered?"
   # Should reference scaffold_service.py based on expertise
   ```

### Edge Cases

1. **Expertise File Already Exists**: `skip_if_exists` action should preserve existing file
2. **Expertise Over 1000 Lines**: Self-improve should compress (Task 5's responsibility)
3. **Invalid YAML**: Self-improve should validate and report errors
4. **Missing CLI Directory**: Self-improve should validate paths exist

## Acceptance Criteria

- [ ] Jinja2 seed template exists: `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/experts/cli/expertise.yaml.j2`
- [ ] Template registered in scaffold_service.py with `skip_if_exists` action
- [ ] Populated expertise file exists: `.claude/commands/experts/cli/expertise.yaml`
- [ ] Expertise file is valid YAML (parseable by Python yaml.safe_load)
- [ ] Expertise file is under 1000 lines
- [ ] Expertise file documents:
  - CLI structure (domain, application, infrastructure, interfaces)
  - Key files with paths
  - Template organization patterns
  - Key operations (scaffold planning, template rendering, etc.)
  - Best practices and patterns
- [ ] All validation commands pass (pytest, ruff, mypy, smoke test)
- [ ] Self-improve workflow completes without errors
- [ ] Question prompt can read and reference expertise

## Validation Commands

Execute all commands to validate with zero regressions:

```bash
# Unit tests
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short

# Linting
cd tac_bootstrap_cli && uv run ruff check .

# Type checking
cd tac_bootstrap_cli && uv run mypy tac_bootstrap/

# Smoke test
cd tac_bootstrap_cli && uv run tac-bootstrap --help

# Expertise validation
wc -l .claude/commands/experts/cli/expertise.yaml
python -c "import yaml; yaml.safe_load(open('.claude/commands/experts/cli/expertise.yaml'))"

# Self-improve test
/experts:cli:self-improve false

# Question prompt test
/experts:cli:question "What is the CLI structure?"
```

## Notes

### Dual Strategy Pattern
This task follows the TAC-13 dual strategy:
- **Strategy A (Template)**: Jinja2 seed template for new projects
- **Strategy B (Registration)**: Template registration with `skip_if_exists`
- **Strategy C (Implementation)**: Populated expertise in repo root

### Expertise File Design
- **Purpose**: Mental model, not source of truth (code is always truth)
- **Max Size**: 1000 lines (context window protection: ~4-6K tokens)
- **Update Frequency**: On-demand via `/experts:cli:self-improve` or automatic via git hooks
- **Validation**: 7-phase workflow ensures accuracy against actual codebase

### Integration with Existing Experts
- CLI Expert joins CC Hook Expert as the second expert domain
- Future experts (ADW, Commands, Database) will follow same pattern
- All experts share the Act → Learn → Reuse loop architecture

### Context Window Economics
- Expertise file: ~4-6K tokens (1000 lines)
- Typical prompt: ~5K tokens
- Claude Sonnet context: 200K tokens
- Remaining for code: ~190K tokens
- Result: 20% expertise, 80% task work (optimal ratio)

### FileAction.SKIP_IF_EXISTS Rationale
Using `skip_if_exists` instead of `create` ensures:
- Expertise files are never overwritten during regeneration
- Learning is preserved across project updates
- Experts maintain continuity of knowledge
- Manual edits to expertise are not lost
