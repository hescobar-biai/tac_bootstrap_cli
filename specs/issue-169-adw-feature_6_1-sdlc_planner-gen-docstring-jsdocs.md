# Feature: LLM-Powered Docstring/JSDoc Generator Template

## Metadata
issue_number: `169`
adw_id: `feature_6_1`
issue_json: `{"number":169,"title":"Tarea 6.1: Template gen_docstring_jsdocs.py","body":"feature\n/adw_sdlc_zte_iso\n/adw_id: feature_6_1\n\n**Tipo**: feature\n**Ganancia**: Los proyectos generados incluyen un script que enriquece el codigo con docstrings IDK-first automaticamente, reduciendo el esfuerzo de documentar.\n\n**Instrucciones para el agente**:\n\n1. Crear template: `tac_bootstrap_cli/tac_bootstrap/templates/scripts/gen_docstring_jsdocs.py.j2`\n2. Crear renderizado en raiz: `scripts/gen_docstring_jsdocs.py` (con permisos de ejecucion)\n3. Tomar como base el script existente en `ai_docs/doc/create-crud-entity/generating-fractal-docs/scripts/gen_docstring_jsdocs.py`\n3. Adaptarlo como template Jinja2 con las siguientes variables:\n   - `{{ config.project.language }}` → determina que lenguajes procesar por default\n   - `{{ config.project.name }}` → nombre del proyecto en docstrings generados\n   - `{{ config.paths.app_root | default(\"src\") }}` → directorio raiz a procesar\n4. El script generado debe:\n   - Soportar Python y TypeScript (AST parsing para Python, regex para TS)\n   - Usar API compatible con OpenAI (configurable: Ollama local, Anthropic, OpenAI)\n   - Modo `add` (solo si no existe), `complement` (agregar secciones faltantes), `overwrite`\n   - Flag `--changed-only` para procesar solo archivos con cambios en git\n   - Flag `--dry-run` para preview\n   - Generar docstrings con formato IDK:\n     ```\n     IDK: keyword1, keyword2, keyword3\n     Responsibility: ...\n     Invariants: ...\n     Inputs: ...\n     Outputs: ...\n     Failure Modes: ...\n     ```\n5. Dependencias requeridas en el script header:\n   ```python\n   # /// script\n   # dependencies = [\"openai\", \"python-dotenv\"]\n   # ///\n**Criterios de aceptacion**:\n- Template renderiza sin errores con config basico\n- Script generado es ejecutable con `uv run`\n- Procesa archivos Python correctamente (AST parsing)\n- Respeta --changed-only y --dry-run\n- Funciona con Ollama local (default) y APIs remotas\nFASE 6: Documentacion Fractal como Skill\n\n**Objetivo**: Incluir los generadores de documentacion fractal como parte de los proyectos generados, con slash command para invocacion facil.\n\n**Ganancia de la fase**: Proyectos generados incluyen herramientas de documentacion automatica que mantienen docs sincronizados con el codigo, usando LLM local o remoto.\n\n---\n"}`

## Feature Description
This feature creates a Jinja2 template for an LLM-powered docstring generator script that will be included in all projects generated by TAC Bootstrap. The script automatically enriches Python and TypeScript code with IDK-format docstrings using configurable AI providers (Ollama local by default, or OpenAI/Anthropic compatible APIs).

The generated script provides intelligent documentation modes (add, complement, overwrite), git integration for processing only changed files, and dry-run capabilities. It uses AST parsing for Python and regex patterns for TypeScript/JavaScript to accurately identify and document code structures.

## User Story
As a developer using TAC Bootstrap-generated projects
I want an automated docstring generator included in my project
So that I can maintain high-quality IDK-format documentation without manual effort, using local or cloud LLM providers

## Problem Statement
Maintaining comprehensive, up-to-date documentation is time-consuming and often neglected. Manual docstring writing is:
- Tedious and error-prone
- Inconsistent across team members
- Difficult to keep synchronized with code changes
- Resource-intensive during rapid development

Projects need an automated way to generate and maintain structured, information-dense documentation that follows the IDK (Information Dense Keywords) format with semantic sections like Purpose, Invariants, Inputs, Outputs, and Failure Modes.

## Solution Statement
Create a Jinja2 template (`gen_docstring_jsdocs.py.j2`) based on the existing reference implementation in `ai_docs/doc/create-crud-entity/generating-fractal-docs/scripts/gen_docstring_jsdocs.py`. The template will:

1. **Parameterize with project-specific configuration** using Jinja2 variables from `config.yml`
2. **Support multiple programming languages** (Python via AST, TypeScript/JavaScript via regex)
3. **Integrate with git workflows** to document only changed files
4. **Provide safety modes** (add/complement/overwrite) with dry-run preview
5. **Work with multiple AI providers** (Ollama local default, OpenAI-compatible APIs)
6. **Generate IDK-format docstrings** with structured sections for maximum information density
7. **Fail fast on API issues** but continue gracefully on individual file parse errors
8. **Process recursively by default** with opt-out via --no-recursive flag

The template will be rendered into the generated project's `scripts/` directory with executable permissions, ready to use with `uv run`.

## Relevant Files

### Existing Reference Implementation
- `ai_docs/doc/create-crud-entity/generating-fractal-docs/scripts/gen_docstring_jsdocs.py` - Base script to adapt as template (828 lines, full implementation with AST/regex parsing, OpenAI-compatible client, IDK prompt engineering)

### TAC Bootstrap Infrastructure
- `tac_bootstrap_cli/tac_bootstrap/domain/models.py` - ProjectConfig, PathsConfig Pydantic models
- `tac_bootstrap_cli/tac_bootstrap/application/template_renderer.py` - Jinja2 rendering service
- `config.yml` - Source of configuration values (project.language, project.name, paths.app_root)
- `tac_bootstrap_cli/tac_bootstrap/templates/scripts/` - Template directory for script templates

### Example Template References
- `tac_bootstrap_cli/tac_bootstrap/templates/scripts/build.sh.j2` - Example shell script template with config variables
- `tac_bootstrap_cli/tac_bootstrap/templates/adws/adw_sdlc_iso.py.j2` - Example Python template with inline script dependencies

### New Files
- `tac_bootstrap_cli/tac_bootstrap/templates/scripts/gen_docstring_jsdocs.py.j2` - New Jinja2 template
- `scripts/gen_docstring_jsdocs.py` - Rendered output in project root (generated from template for testing/validation)

### Testing
- `tac_bootstrap_cli/tests/test_template_rendering.py` - Add new test cases for this template
- `tac_bootstrap_cli/tests/fixtures/` - Test config fixtures

## Implementation Plan

### Phase 1: Template Creation
Create the Jinja2 template structure with proper inline script dependencies header and Jinja2 variable placeholders.

1. Copy base script from `ai_docs/doc/create-crud-entity/generating-fractal-docs/scripts/gen_docstring_jsdocs.py`
2. Add PEP 723 inline script dependencies header at the top
3. Insert Jinja2 variables for project configuration:
   - `{{ config.project.language }}` for determining default file extensions
   - `{{ config.project.name }}` for generated docstring context
   - `{{ config.paths.app_root | default("src") }}` for default directory to process
4. Create template file at `tac_bootstrap_cli/tac_bootstrap/templates/scripts/gen_docstring_jsdocs.py.j2`

### Phase 2: Script Enhancements
Enhance the script functionality based on auto-resolved clarifications.

1. Update default API configuration:
   - Default base URL: `http://localhost:11434/v1/`
   - Default model: `llama3.2`
   - Support environment variables: `OLLAMA_BASE_URL`, `OLLAMA_MODEL`, `OPENAI_API_KEY`
2. Add CLI flags:
   - `--no-recursive` flag to limit processing to single directory
   - `--public-only` flag to exclude private methods/functions
   - `--exclude` pattern support for excluding specific files
3. Implement git integration for `--changed-only`:
   - Execute `git diff --name-only HEAD` for uncommitted changes
   - Execute `git diff --cached --name-only` for staged changes
   - Combine and filter for relevant file extensions
4. Update default mode to `add` (safest option)
5. Add startup validation for API configuration (fail fast)
6. Enhance error handling:
   - Continue processing on individual file parse errors
   - Log warnings with filename and error details
   - Exit code 0 if some files succeed
7. Extend TypeScript support:
   - Add `.js` and `.jsx` file extensions
   - Update regex patterns to match additional constructs if needed
8. Update docstring format to match requirements:
   - Change "Purpose:" to "Responsibility:" (per issue requirements)
   - Ensure all IDK sections are included: IDK, Responsibility, Invariants, Inputs, Outputs, Failure Modes
   - Update prompts to reflect this structure

### Phase 3: Integration with TAC Bootstrap
Integrate the template into the TAC Bootstrap rendering pipeline.

1. Verify template renders correctly with test config
2. Add template to the list of rendered scripts in the generator
3. Ensure rendered script has executable permissions (mode 0o755)
4. Test rendering with various config.yml configurations:
   - Python projects (language: python)
   - TypeScript projects (language: typescript)
   - Multi-language projects
5. Validate that `config.paths.app_root` default filter works correctly

## Step by Step Tasks

### Task 1: Create Base Template Structure
- Create `tac_bootstrap_cli/tac_bootstrap/templates/scripts/gen_docstring_jsdocs.py.j2`
- Copy content from `ai_docs/doc/create-crud-entity/generating-fractal-docs/scripts/gen_docstring_jsdocs.py`
- Add PEP 723 inline script dependencies header:
  ```python
  # /// script
  # dependencies = ["openai", "python-dotenv"]
  # ///
  ```
- Update shebang and docstring with project-agnostic language

### Task 2: Insert Jinja2 Configuration Variables
- Replace hardcoded default paths with `{{ config.paths.app_root | default("src") }}`
- Add project name context: `{{ config.project.name }}` in docstring generation prompts
- Create language-based default extension logic using `{{ config.project.language }}`
- Add template comments explaining each Jinja2 variable

### Task 3: Update Default API Configuration
- Change default base_url to `http://localhost:11434/v1/`
- Change default model to `llama3.2`
- Add environment variable support:
  ```python
  import os
  from dotenv import load_dotenv
  load_dotenv()
  default_base_url = os.getenv("OLLAMA_BASE_URL", "http://localhost:11434/v1/")
  default_model = os.getenv("OLLAMA_MODEL", "llama3.2")
  default_api_key = os.getenv("OPENAI_API_KEY", "ollama")
  ```

### Task 4: Add New CLI Flags
- Add `--no-recursive` flag (default False) to limit to single directory
- Add `--public-only` flag (default False) to exclude private items
- Add `--exclude` parameter for file pattern exclusion
- Update help text for all flags
- Integrate flags into file iteration logic

### Task 5: Implement Git Integration
- Create helper function `get_changed_files(repo: Path) -> List[Path]`
- Execute `git diff --name-only HEAD` and parse output
- Execute `git diff --cached --name-only` and parse output
- Combine and deduplicate file lists
- Filter for relevant file extensions (.py, .ts, .tsx, .js, .jsx)
- Integrate with `--changed-only` flag in main()

### Task 6: Enhance Error Handling and Validation
- Add API validation at startup (check credentials before processing)
- Wrap file processing in try-except with specific error types
- Log parse errors with `logging.warning(f"Skipping {file}: {error}")`
- Continue processing remaining files on individual failures
- Return success (exit 0) if at least some files processed successfully

### Task 7: Update IDK Documentation Format
- Change "Purpose:" section to "Responsibility:"
- Update `PY_REQUIRED` list to match: ["Responsibility:", "Tags:", "Ownership:", "Invariants:", "Side effects:", "Inputs:", "Outputs:", "Failure modes:", IDK_PREFIX]
- Update `TS_REQUIRED` list similarly
- Modify prompt templates to generate "Responsibility:" instead of "Purpose:"
- Ensure all prompts include the correct section names

### Task 8: Extend Language Support
- Add `.js` and `.jsx` to file extension detection
- Verify regex patterns work for JavaScript (should work with existing TS patterns)
- Add language detection logic based on `{{ config.project.language }}`
- Test with JavaScript sample files

### Task 9: Update Default Mode and Safety
- Change default mode from "complement" to "add" in argparse
- Add warning in help text about committing before using overwrite mode
- Update README/docstring to document safety best practices
- Ensure dry-run preview shows exactly what would change

### Task 10: Test Template Rendering
- Create test case in `tac_bootstrap_cli/tests/test_template_rendering.py`
- Test rendering with Python project config
- Test rendering with TypeScript project config
- Verify Jinja2 variables are properly substituted
- Validate rendered script syntax (Python syntax check)

### Task 11: Render Script to Project Root
- Use TAC Bootstrap's template renderer to generate `scripts/gen_docstring_jsdocs.py`
- Set executable permissions on generated file (chmod +x)
- Verify script can be executed with `uv run scripts/gen_docstring_jsdocs.py --help`
- Test script functionality with sample Python and TypeScript files

### Task 12: Integration Testing
- Create test Python files with no docstrings
- Run script in `add` mode and verify docstrings are added
- Create test files with partial docstrings
- Run script in `complement` mode and verify missing sections are added
- Test `--dry-run` flag shows changes without modifying files
- Test `--changed-only` flag with git-tracked changes
- Test `--public-only` flag excludes private methods

### Task 13: Validation and Documentation
- Run all validation commands (see Validation Commands section below)
- Document script usage in project README or inline help
- Add examples of common usage patterns
- Document environment variable configuration
- Verify all acceptance criteria are met

## Testing Strategy

### Unit Tests
- **Template Rendering Tests** (`test_template_rendering.py`):
  - Test template renders without errors with minimal config
  - Test Jinja2 variable substitution (project.name, project.language, paths.app_root)
  - Test default filter works correctly for missing config values
  - Test rendered output is valid Python syntax

- **Script Functionality Tests** (in rendered script):
  - Test Python AST parsing with valid and invalid syntax
  - Test TypeScript regex matching for classes, functions, interfaces
  - Test docstring insertion logic (add mode)
  - Test docstring complementing logic (complement mode)
  - Test docstring replacement logic (overwrite mode)
  - Test git integration returns correct changed files
  - Test API configuration validation

### Integration Tests
- **End-to-End Workflow**:
  - Generate project with TAC Bootstrap CLI
  - Verify `scripts/gen_docstring_jsdocs.py` exists and is executable
  - Create sample Python file without docstrings
  - Run script in add mode, verify docstrings are added
  - Modify sample file, run script in complement mode
  - Verify only missing sections are added, existing content preserved

### Edge Cases
- Empty files (no functions or classes to document)
- Files with syntax errors (should skip with warning)
- Files with malformed existing docstrings
- Very large files (test performance and memory)
- Files in .gitignore (should process if in target directory)
- Binary files or non-text files (should skip gracefully)
- Unicode characters in code and docstrings
- Private methods with single underscore vs double underscore
- Nested classes and methods
- Async functions and methods
- Property decorators, classmethods, staticmethods
- TypeScript interfaces, type aliases, enums
- JavaScript arrow functions, class fields
- Git repositories with no commits (git commands should handle gracefully)
- Missing API credentials (should fail fast with clear error)
- API rate limiting or network errors (should report clearly)
- Concurrent execution on same files (file locking not required, document limitation)

## Acceptance Criteria
- [ ] Template file `tac_bootstrap_cli/tac_bootstrap/templates/scripts/gen_docstring_jsdocs.py.j2` exists and is valid Jinja2
- [ ] Template renders without errors using basic config (Python project with default paths)
- [ ] Rendered script includes PEP 723 inline dependencies header
- [ ] Script has executable permissions when rendered
- [ ] Script can be invoked with `uv run scripts/gen_docstring_jsdocs.py --help`
- [ ] Script successfully processes Python files using AST parsing
- [ ] Script successfully processes TypeScript/JavaScript files using regex
- [ ] `--dry-run` flag shows proposed changes without modifying files
- [ ] `--changed-only` flag processes only git-modified files
- [ ] `--no-recursive` flag limits processing to single directory
- [ ] `--public-only` flag excludes private functions/methods
- [ ] Default mode is `add` (safest option)
- [ ] Script works with Ollama local (default configuration)
- [ ] Script works with OpenAI-compatible APIs (via env vars or CLI flags)
- [ ] Generated docstrings include all required IDK sections: IDK, Responsibility, Invariants, Inputs, Outputs, Failure Modes
- [ ] Script fails fast with clear error if API credentials missing
- [ ] Script continues processing after individual file parse errors
- [ ] Script logs warnings for skipped files with error details
- [ ] Jinja2 variable `{{ config.project.language }}` determines default extensions
- [ ] Jinja2 variable `{{ config.project.name }}` appears in generated docstrings
- [ ] Jinja2 variable `{{ config.paths.app_root }}` defaults to "src" if not set
- [ ] All validation commands pass (pytest, ruff, mypy, smoke test)

## Validation Commands
Execute all commands to validate with zero regressions:

```bash
# 1. Unit tests
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short

# 2. Linting
cd tac_bootstrap_cli && uv run ruff check .

# 3. Type checking
cd tac_bootstrap_cli && uv run mypy tac_bootstrap/

# 4. Smoke test - CLI help
cd tac_bootstrap_cli && uv run tac-bootstrap --help

# 5. Template rendering test (manual)
cd tac_bootstrap_cli && uv run python -c "
from tac_bootstrap.application.template_renderer import TemplateRenderer
from tac_bootstrap.domain.models import ProjectConfig, PathsConfig
from pathlib import Path

config = ProjectConfig(
    name='test-project',
    language='python',
    paths=PathsConfig(app_root='src')
)

renderer = TemplateRenderer(Path('tac_bootstrap/templates'))
rendered = renderer.render_template(
    'scripts/gen_docstring_jsdocs.py.j2',
    {'config': config}
)
print('Template rendered successfully:', len(rendered), 'bytes')
"

# 6. Rendered script validation
uv run scripts/gen_docstring_jsdocs.py --help

# 7. Functional test - dry run on test file
echo "def test_func(): pass" > /tmp/test_sample.py
uv run scripts/gen_docstring_jsdocs.py --repo /tmp --include-glob "test_sample.py" --mode add --dry-run
```

## Notes

### Design Decisions
1. **Default to `add` mode**: Safest option that won't modify existing documentation
2. **Fail fast on API issues**: Better UX than processing many files then failing
3. **Continue on parse errors**: One bad file shouldn't block entire codebase
4. **No config file initially**: Environment variables + CLI flags are sufficient for v1
5. **No automatic backups**: Users should use git for version control
6. **Recursive by default**: Expected behavior for documentation tools

### Future Enhancements (Out of Scope for v1)
- Configuration file support (.gen_docstring_config.json)
- Automatic backup creation (*.bak files)
- Parallel processing of multiple files
- Integration with pre-commit hooks
- Support for additional languages (Go, Rust, Java)
- IDK keyword validation against domain registries
- Automatic detection of API provider from endpoint
- Progress bar for large codebases
- Interactive mode for reviewing each change
- Integration with CI/CD pipelines

### Dependencies
The script requires these dependencies (via inline PEP 723 specification):
- `openai` - OpenAI-compatible API client
- `python-dotenv` - Environment variable loading

No changes to TAC Bootstrap CLI dependencies required.

### Environment Variables
Users can configure the script via environment variables:
- `OLLAMA_BASE_URL` - Default: http://localhost:11434/v1/
- `OLLAMA_MODEL` - Default: llama3.2
- `OPENAI_API_KEY` - API key for authentication (default: "ollama" for Ollama)

### Performance Considerations
- AST parsing is fast for Python files (no external process)
- Regex parsing for TypeScript is lightweight
- LLM API calls are the bottleneck (network latency + generation time)
- Consider `--sleep-s` flag for rate limiting if hitting API quotas
- Large codebases: use `--include-glob` or `--changed-only` to limit scope

### Security Considerations
- API keys should be stored in environment variables, not command line
- Script validates API configuration before processing
- No automatic execution of generated code
- No network requests except to configured API endpoint
- No file system writes outside target directory (when not in dry-run)
- Git commands are read-only (git diff)

### Compatibility
- Python 3.10+ required (for type hints and modern syntax)
- Works with `uv` package manager (PEP 723 inline dependencies)
- Compatible with Ollama, OpenAI, Anthropic, and any OpenAI-compatible API
- Git repository not required (git integration is optional via `--changed-only`)
