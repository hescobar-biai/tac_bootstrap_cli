# Feature: Improve /document Template with IDK Frontmatter

## Metadata
issue_number: `184`
adw_id: `feature_7_1`
issue_json: `{"number":184,"title":"Tarea 7.1: Mejorar template /document con frontmatter IDK","body":"feature\n/adw_sdlc_zte_iso\n/adw_id: feature_7_1\n\n*Tipo**: feature\n**Ganancia**: Las feature docs generadas incluyen frontmatter con keywords IDK, haciendo que sean indexables y buscables semanticamente.\n\n**Instrucciones para el agente**:\n\n1. Modificar template: `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/document.md.j2`\n2. Actualizar renderizado en raiz: `.claude/commands/document.md`\n2. Agregar al formato de documentacion generada un frontmatter:\n   ```markdown\n   ---\n   doc_type: feature\n   adw_id: {adw_id}\n   date: {YYYY-MM-DD}\n   idk:\n     - keyword1\n     - keyword2\n   tags:\n     - feature\n     - {capability}\n   related_code:\n     - src/{files_modified}\n   ---\n   ```\n3. Agregar instruccion al prompt del command para que el agente:\n   - Extraiga 5-8 IDK keywords del codigo implementado\n   - Use vocabulario de `canonical_idk.yml` si existe\n   - Incluya seccion \"Testing\" con comandos ejecutables\n4. Agregar paso final: \"Update conditional_docs.md with entry for this new documentation\"\n\n**Criterios de aceptacion**:\n- Template renderiza correctamente\n- Instrucciones son claras para el agente que ejecuta /document\n- Frontmatter incluye IDK keywords\n\n# FASE 7: Document Workflow Mejorado\n\n**Objetivo**: Mejorar el template existente de /document para incluir frontmatter IDK y integracion con docs fractal.\n\n**Ganancia de la fase**: La documentacion de features generada automaticamente es mas rica, consistente, y encontrable por agentes AI.\n"}`

## Feature Description
This feature enhances the `/document` command template to include YAML frontmatter with IDK (Information Dense Keywords) metadata, making generated feature documentation semantically searchable and indexable. The improved template guides agents to extract domain-relevant keywords from implemented code, reference canonical terminology when available, and include executable testing commands.

The enhancement transforms plain feature documentation into structured, metadata-rich documents that integrate with the fractal documentation system, enabling better discoverability and semantic search by AI agents.

## User Story
As a developer using TAC Bootstrap-generated projects
I want feature documentation generated by /document to include structured frontmatter with IDK keywords
So that documentation is semantically searchable, indexable, and follows consistent domain terminology

## Problem Statement
Currently, the `/document` command generates markdown documentation without structured metadata. This creates several issues:
- Documentation lacks semantic keywords for AI agent discovery
- No connection to canonical domain terminology
- Missing metadata about related code files
- No link to the ADW workflow that generated the code
- Testing instructions are inconsistent or missing
- Documentation doesn't integrate well with the fractal docs system

Generated documentation is essentially "floating" text without machine-readable structure that would enable semantic search, cross-referencing, or automated indexing.

## Solution Statement
Enhance the existing `/document` template (`document.md.j2`) to:

1. **Add YAML frontmatter** with hardcoded `---` delimiters containing:
   - `doc_type`: Always "feature" for this command
   - `adw_id`: Passed via Jinja2 variable `{{ config.adw_id | default('N/A') }}`
   - `date`: Current date in YYYY-MM-DD format
   - `idk`: List of 3-8 keywords extracted from code
   - `tags`: List including "feature" and `{{ config.capability | default('general') }}`
   - `related_code`: List of all modified files including tests

2. **Update agent instructions** to:
   - Extract 3-8 IDK keywords from implemented code analysis
   - Prioritize `canonical_idk.yml` vocabulary when available, supplement with feature-specific terms as needed
   - Include a "Testing" section with executable bash commands and brief explanations
   - Add final step: "Update conditional_docs.md with entry for this new documentation"

3. **Maintain existing functionality** while adding frontmatter to the Documentation Format section

The template changes will be synchronized to both the Jinja2 template file and the root `.claude/commands/document.md` file.

## Relevant Files

### Template Files (Primary)
- `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/document.md.j2` - Jinja2 template to modify
- `.claude/commands/document.md` - Rendered file in project root to update

### Reference Files
- `canonical_idk.yml` - Canonical vocabulary file (optional, used by agents when exists)
- `.claude/commands/conditional_docs.md` - Will be updated by agents after running /document
- `config.yml` - Source of configuration values (adw_id, capability)

### Related Documentation Templates
- `tac_bootstrap_cli/tac_bootstrap/templates/config/canonical_idk.yml.j2` - Template for canonical keywords
- `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/conditional_docs.md.j2` - Conditional docs template

### Testing
- Manual validation: render template with test config and verify frontmatter structure
- Integration test: run /document command and verify generated markdown has valid frontmatter

## Implementation Plan

### Phase 1: Understand Current Template
Analyze the existing document.md.j2 template to understand:
- Current structure and sections
- Existing Jinja2 variables used
- Current agent instructions flow
- Documentation format specification

### Phase 2: Design Frontmatter Structure
Define the exact frontmatter structure with:
- Hardcoded YAML delimiters (`---`)
- Jinja2 variables with sensible defaults
- Clear structure for IDK keywords list
- Tags array format
- Related code file paths structure

### Phase 3: Modify Template
Update the template to:
- Add frontmatter section to Documentation Format
- Insert Jinja2 variables for adw_id and capability
- Update agent instructions with keyword extraction guidance
- Add Testing section requirement to instructions
- Add conditional_docs.md update step

### Phase 4: Update Root File
Synchronize changes from template to `.claude/commands/document.md` by:
- Rendering the template with default config
- Ensuring Spanish language is preserved (existing file is in Spanish)
- Verifying all instructions translate correctly

## Step by Step Tasks

### Task 1: Read and Analyze Current Template
- Read `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/document.md.j2`
- Read `.claude/commands/document.md` to understand current state
- Identify where frontmatter should be inserted in Documentation Format section
- Identify where new agent instructions should be added

### Task 2: Design Frontmatter Structure
- Create frontmatter YAML structure with:
  ```markdown
  ---
  doc_type: feature
  adw_id: {{ config.adw_id | default('N/A') }}
  date: <current date YYYY-MM-DD>
  idk:
    - keyword1
    - keyword2
    - keyword3
  tags:
    - feature
    - {{ config.capability | default('general') }}
  related_code:
    - path/to/file1.py
    - path/to/test_file1.py
  ---
  ```
- Ensure YAML is valid and follows standard format

### Task 3: Update Template Instructions
- Add step to analyze git diff and extract 3-8 IDK keywords
- Add instruction: "Prioritize keywords from canonical_idk.yml if it exists, supplement with feature-specific terms as needed"
- Add instruction to include "Testing" section with format:
  - Brief description of test
  - Code block with executable bash command
- Add final step: "After creating the file, read `.claude/commands/conditional_docs.md` and add entry for the new file with appropriate conditions"

### Task 4: Modify Documentation Format Section
- Insert frontmatter block at the beginning of the markdown format
- Keep all existing sections (Overview, What Was Built, Technical Implementation, etc.)
- Add new "Testing" section between "Configuration" and "Notes":
  ```markdown
  ## Testing

  <Description of how to test the feature>

  ```bash
  <executable command 1>
  ```

  <Description of additional test if needed>

  ```bash
  <executable command 2>
  ```
  ```

### Task 5: Update Template File
- Modify `tac_bootstrap_cli/tac_bootstrap/templates/claude/commands/document.md.j2`
- Add frontmatter structure to Documentation Format section
- Update Instructions section with new steps (keywords, canonical_idk.yml, Testing section, conditional_docs update)
- Preserve all existing Jinja2 variables and logic
- Ensure template comments are clear

### Task 6: Render and Update Root File
- Render the template with default configuration
- Update `.claude/commands/document.md` with rendered output
- Preserve Spanish language in the root file
- Ensure all placeholders and examples are translated appropriately

### Task 7: Validation
- Manually verify template renders without errors
- Check YAML frontmatter syntax is valid
- Verify Jinja2 variables have appropriate defaults
- Ensure all instructions are clear and actionable
- Validate that both template and rendered file are synchronized

## Testing Strategy

### Manual Template Validation
- Render template with minimal config (only required fields)
- Render template with full config (all optional fields populated)
- Verify YAML frontmatter parses correctly with a YAML parser
- Check that default values work when config fields are missing

### Agent Instruction Validation
- Read through instructions as if executing /document command
- Verify each step is actionable and unambiguous
- Check that IDK keyword extraction guidance is clear
- Validate Testing section format is easy to follow
- Ensure conditional_docs.md update step is explicit

### Integration Validation
- Simulate running /document with a test feature implementation
- Verify frontmatter is generated correctly with actual values
- Check that canonical_idk.yml reference works when file exists
- Validate that conditional_docs.md update instruction is clear

## Acceptance Criteria

1. **Template Renders Correctly**
   - `document.md.j2` template renders without Jinja2 errors
   - YAML frontmatter is syntactically valid
   - All Jinja2 variables have appropriate defaults
   - Template works with minimal and full config

2. **Frontmatter Structure Complete**
   - Contains all required fields: doc_type, adw_id, date, idk, tags, related_code
   - Uses hardcoded `---` YAML delimiters
   - `{{ config.adw_id | default('N/A') }}` variable works correctly
   - `{{ config.capability | default('general') }}` variable works correctly
   - idk field is a YAML list of strings
   - related_code field is a YAML list of file paths

3. **Agent Instructions Clear**
   - Instructions explicitly state to extract 3-8 IDK keywords
   - Guidance to prioritize canonical_idk.yml vocabulary is clear
   - Testing section requirement is explicit with format examples
   - Final step to update conditional_docs.md is present and actionable
   - All steps maintain existing git diff analysis instructions

4. **Documentation Format Updated**
   - Frontmatter appears at the beginning of the markdown format
   - New "Testing" section is added between Configuration and Notes
   - All existing sections are preserved
   - Format examples are clear and complete

5. **Root File Synchronized**
   - `.claude/commands/document.md` matches template output
   - Spanish language is preserved in root file
   - All instructions are properly translated
   - File is ready for immediate use by agents

6. **Canonical IDK Integration**
   - Instructions reference canonical_idk.yml optionally (if exists)
   - Agents are guided to supplement canonical terms with feature-specific keywords
   - No failure occurs when canonical_idk.yml doesn't exist

7. **Testing Section Well-Defined**
   - Format uses executable bash commands
   - Commands have brief explanatory text
   - Examples show proper code block formatting
   - Instructions are practical and copy-pasteable

8. **Conditional Docs Integration**
   - Final instruction step added to update conditional_docs.md
   - Step appears after documentation file creation
   - Instruction is clear about adding entry with appropriate conditions

## Validation Commands

Run all commands to validate with zero regressions:

```bash
# Render template with test config (manual step - verify output)
cd tac_bootstrap_cli && uv run python -c "
from tac_bootstrap.infrastructure.template_repo import TemplateRepository
from tac_bootstrap.domain.models import TACConfig, ProjectSpec, PathsSpec, Language
config = TACConfig(
    project=ProjectSpec(name='test-project', language=Language.PYTHON),
    paths=PathsSpec()
)
repo = TemplateRepository()
output = repo.render('claude/commands/document.md.j2', {'config': config})
print(output[:500])  # Print first 500 chars to verify frontmatter
"

# Validate YAML frontmatter syntax (after rendering)
cd tac_bootstrap_cli && python -c "
import yaml
# Simulate frontmatter extraction
frontmatter_sample = '''---
doc_type: feature
adw_id: test_123
date: 2026-01-24
idk:
  - keyword1
  - keyword2
tags:
  - feature
  - general
related_code:
  - src/file.py
---'''
parsed = yaml.safe_load(frontmatter_sample.split('---')[1])
assert parsed['doc_type'] == 'feature'
assert isinstance(parsed['idk'], list)
print('Frontmatter YAML is valid âœ“')
"

# Run standard validation suite
cd tac_bootstrap_cli && uv run pytest tests/ -v --tb=short
cd tac_bootstrap_cli && uv run ruff check .
cd tac_bootstrap_cli && uv run mypy tac_bootstrap/
cd tac_bootstrap_cli && uv run tac-bootstrap --help
```

## Notes

### Auto-Resolved Clarifications Applied
- Frontmatter delimiters are hardcoded `---` (standard YAML)
- canonical_idk.yml is optional (graceful degradation)
- adw_id uses Jinja2 variable `{{ config.adw_id | default('N/A') }}`
- capability uses Jinja2 variable `{{ config.capability | default('general') }}`
- related_code lists all modified files including tests
- Testing section uses executable bash commands with brief explanations
- conditional_docs.md update is added as final instruction step
- Keywords are guideline (3-8), not strictly validated
- Agents can supplement canonical keywords with feature-specific terms
- Minimum 3 keywords allowed if feature is small

### Implementation Considerations
- Maintain backward compatibility: /document should work in projects without canonical_idk.yml
- Spanish language preservation: Root file `.claude/commands/document.md` is in Spanish, maintain this
- Template and root file synchronization: Changes must be reflected in both files
- No validation logic: Template doesn't validate keyword count, agents handle this
- Flexibility: Design allows agents to adapt to different feature sizes and domains

### Future Enhancements
- Could add schema validation for frontmatter in a future iteration
- Could integrate with fractal docs generation workflow
- Could add /document variants for different doc types (bug, chore, etc.)
- Could add automatic canonical_idk.yml suggestion based on language/framework
