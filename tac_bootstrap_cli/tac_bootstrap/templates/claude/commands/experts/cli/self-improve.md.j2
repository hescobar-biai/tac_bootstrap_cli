---
allowed-tools: Read, Grep, Glob, Bash, Edit, Write, TodoWrite
description: Self-improve CLI expertise by validating against codebase
argument-hint: [check_git_diff] [focus_area]
model: sonnet
---

# CLI Expert: Self-Improve Mode

## Purpose

Maintain and update the CLI expert's mental model (expertise.yaml) by validating it against the actual codebase and incorporating new knowledge.

This is the **Learn** step in the Act → Learn → Reuse loop.

## Variables

- **CHECK_GIT_DIFF**: `$1` (default: `false`) - If `true`, focus on recently changed files
- **FOCUS_AREA**: `$2` (default: empty) - Optional area to focus on (e.g., "templates", "scaffold_service", "cli_commands")
- **EXPERTISE_FILE**: `.claude/commands/experts/cli/expertise.yaml` (static)
- **CLI_ROOT**: Project CLI root directory (static)
- **MAX_LINES**: `1000` (static)

## Instructions

You are the CLI Expert updating your mental model. Follow the 7-phase workflow strictly:

1. **Check git diff** (if requested)
2. **Read current expertise**
3. **Validate against codebase**
4. **Identify discrepancies**
5. **Update expertise**
6. **Enforce line limit**
7. **Validate YAML syntax**

**Key Principles:**
- Expertise is a mental model, NOT source of truth
- Focus on patterns and high-value knowledge
- Keep under 1000 lines (compress if needed)
- Always validate YAML syntax before finishing

## Workflow

### Phase 1: Check Git Diff (Conditional)

**Execute only if CHECK_GIT_DIFF is `true`**

1. Run git diff to see recent changes:
   ```bash
   # Check unstaged changes
   git diff HEAD

   # Check staged changes
   git diff --cached

   # Check last commit
   git log -1 --stat --oneline
   ```

2. Identify changed files in CLI domain:
   ```bash
   # List changed files
   git diff --name-only HEAD
   ```

3. Note focus areas based on changes:
   - If scaffold/template files changed → focus on template registration
   - If CLI command files changed → focus on CLI commands
   - If core application files changed → focus on application logic
   - If domain/model files changed → focus on data models

4. Update FOCUS_AREA internally based on findings

**If CHECK_GIT_DIFF is `false`**: Skip to Phase 2

### Phase 2: Read Current Expertise

1. Read the existing expertise file:
   ```bash
   cat .claude/commands/experts/cli/expertise.yaml
   ```

2. Parse the structure:
   - Note `last_updated` date
   - Review all `core_implementation` components
   - Check `key_operations` workflows
   - Review `recent_changes` entries

3. Identify sections to validate:
   - If FOCUS_AREA is set: prioritize that section
   - Otherwise: validate all sections systematically

4. Track current line count:
   ```bash
   wc -l .claude/commands/experts/cli/expertise.yaml
   ```

### Phase 3: Validate Expertise Against Codebase

**Systematic validation of expertise claims**

1. **Validate Overview Section**:
   ```bash
   # Check if key_files exist and are current
   # Read key files mentioned in expertise
   ```

2. **Validate Core Implementation**:
   ```bash
   # For each component in core_implementation
   # Read the actual file
   # Check if documented classes exist
   # Verify method signatures
   # Check line numbers are accurate
   ```

3. **Validate Key Operations**:
   ```bash
   # Verify workflow patterns described in expertise
   # Find actual implementation patterns
   # Verify pattern matches expertise description
   ```

4. **Discover New Information**:
   ```bash
   # Find files not yet documented
   # Check for new important functions
   # Discover new patterns or changes
   ```

5. **Check for Architectural Changes**:
   - New modules or packages?
   - Moved files?
   - Refactored functions?
   - New patterns introduced?

### Phase 4: Identify Discrepancies

**Document ALL differences between expertise and reality**

Create a discrepancies report:

```markdown
## Discrepancies Found

### Outdated Information
- [ ] Expertise says: "X is at line 100"
      Reality: X is at line 120 (moved due to new imports)

- [ ] Expertise documents: method_old()
      Reality: method_old() was renamed to method_new()

### Missing Information
- [ ] New file added: `path/to/new-file.ext`
      Not documented in expertise

- [ ] New method in Component: `new_method()`
      Should be documented in key_operations

### Incorrect Information
- [ ] Expertise: "Pattern uses approach X"
      Reality: Pattern changed to approach Y in recent refactor

### Gaps in Coverage
- [ ] No documentation for: `path/to/important-file.ext`
- [ ] Missing workflow: "How feature X works"
```

### Phase 5: Update Expertise File

**Apply updates based on discrepancies**

1. **Update Overview** (if needed):
   ```yaml
   overview:
     description: "Updated description if system changed"
     key_files:
       - "add new important files"
       - "remove obsolete files"
     last_updated: "2026-02-03"  # Always update date
   ```

2. **Update Core Implementation**:
   ```yaml
   core_implementation:
     component_name:
       location: "path/to/file.ext"
       key_methods:
         - name: "method_name"
           line_start: 150  # Update if moved
           line_end: 200
           signature: "def method_name(params)"
           logic: "Brief description of what it does"
   ```

3. **Update Key Operations**:
   ```yaml
   key_operations:
     operation_name:
       workflow: |
         1. Step one
         2. Step two
         3. Step three
   ```

4. **Add Recent Changes**:
   ```yaml
   recent_changes:
     - date: "2026-02-03"
       description: "Brief description of changes"
       files: ["file1.ext", "file2.ext"]
     # Keep only 5 most recent entries
   ```

5. **Use Edit tool for surgical updates**:
   - Update specific sections using Edit tool
   - Preserve structure and formatting

6. **Or use Write tool for major changes**:
   - If expertise needs significant restructuring, rewrite entire file

### Phase 6: Enforce Line Limit

**Ensure expertise stays under 1000 lines**

1. Check current line count:
   ```bash
   wc -l .claude/commands/experts/cli/expertise.yaml
   ```

2. **If under 1000 lines**: Proceed to Phase 7

3. **If over 1000 lines**: Compress using these strategies:

   **Strategy 1: Remove Old Recent Changes**
   ```yaml
   recent_changes:
     # Keep only 3-5 most recent, remove older ones
     - date: "2026-02-03"
       description: "Latest change"
   ```

   **Strategy 2: Consolidate Similar Patterns**
   ```yaml
   # Before (verbose):
   key_methods:
     - name: "method_a"
       line_start: 10
       logic: "Does X"
     - name: "method_b"
       line_start: 20
       logic: "Does X"

   # After (consolidated):
   key_methods:
     - pattern: "X-type methods"
       instances: ["method_a:10", "method_b:20"]
       logic: "Does X"
   ```

   **Strategy 3: Use Line Ranges Instead of Details**
   ```yaml
   # Before:
   key_methods:
     - name: "method_1"
       line_start: 10
       line_end: 20
     - name: "method_2"
       line_start: 25
       line_end: 35

   # After:
   key_methods_range:
     lines: "10-35"
     count: 2
     purpose: "Helper methods for X"
   ```

   **Strategy 4: Remove Obvious Information**
   ```yaml
   # Remove patterns that are self-evident from code
   # Keep only non-obvious knowledge and relationships
   ```

4. After compression, verify:
   ```bash
   wc -l .claude/commands/experts/cli/expertise.yaml
   # Must be <= 1000
   ```

### Phase 7: Validate YAML Syntax

**Final validation before finishing**

1. Validate YAML syntax:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('.claude/commands/experts/cli/expertise.yaml'))"
   ```

2. **If validation passes**:
   ```
   ✓ YAML syntax is valid
   ```

3. **If validation fails**:
   - Read error message
   - Fix syntax errors (indentation, quotes, colons)
   - Re-run validation
   - Repeat until valid

4. Verify structure:
   ```bash
   # Check required top-level keys exist
   grep -E "^(overview|core_implementation|key_operations):" .claude/commands/experts/cli/expertise.yaml
   ```

5. Final checks:
   ```bash
   # Line count
   lines=$(wc -l < .claude/commands/experts/cli/expertise.yaml)
   echo "✓ Line count: $lines / 1000"

   # YAML valid
   python3 -c "import yaml; yaml.safe_load(open('.claude/commands/experts/cli/expertise.yaml'))" && echo "✓ Valid YAML"

   # Required keys present
   grep -q "^overview:" .claude/commands/experts/cli/expertise.yaml && echo "✓ Has overview"
   grep -q "^core_implementation:" .claude/commands/experts/cli/expertise.yaml && echo "✓ Has core_implementation"
   ```

## Report Format

Provide a detailed report of the self-improve run:

```markdown
# CLI Expert Self-Improve Report

## Execution Summary
- **Date**: 2026-02-03
- **Check Git Diff**: [true/false]
- **Focus Area**: [area or "full validation"]
- **Duration**: [X] phases completed

## Phase 1: Git Diff Analysis
[If CHECK_GIT_DIFF was true]
- Changed files: [list]
- Focus areas identified: [areas]

## Phase 2: Current Expertise Review
- Last updated: [date from expertise]
- Line count: [X] / 1000
- Sections reviewed: [list]

## Phase 3: Validation Results
- Files validated: [count]
- Methods verified: [count]
- Patterns checked: [count]

## Phase 4: Discrepancies Found
### Outdated Information
- [Item 1]
- [Item 2]

### Missing Information
- [Item 1]
- [Item 2]

### Incorrect Information
- [Item 1]

## Phase 5: Updates Applied
- Overview: [updated/unchanged]
- Core Implementation: [X updates]
- Key Operations: [X updates]
- Recent Changes: [added entry]

Specific updates:
1. [Update description]
2. [Update description]

## Phase 6: Line Limit Enforcement
- Before: [X] lines
- After: [Y] lines
- Status: ✅ Under 1000 / ⚠️ Compressed to fit

Compression applied:
- [Strategy used if compressed]

## Phase 7: Validation
- YAML syntax: ✅ Valid
- Required keys: ✅ Present
- Line count: ✅ [Y] / 1000

## Recommendations
- [Any recommendations for manual review]
- [Suggestions for next self-improve run]

## Next Steps
- Run `/experts:cli:question` to verify updated expertise
- Consider self-improve again after next major CLI changes
```

## Success Criteria

Self-improve is successful if:
1. ✅ All 7 phases completed
2. ✅ Expertise is valid YAML
3. ✅ Line count ≤ 1000
4. ✅ All discrepancies documented and addressed
5. ✅ `last_updated` field updated to current date
6. ✅ Report is comprehensive and actionable
