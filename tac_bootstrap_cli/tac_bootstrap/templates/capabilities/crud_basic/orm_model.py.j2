"""
IDK: orm-model, {{ entity.snake_name }}, sqlalchemy

Module: {{ entity.snake_name }}_model

Responsibility:
- Define SQLAlchemy ORM model for {{ entity.name }}
- Map domain entity to database table
- Define columns, indexes, and constraints

Key Components:
- {{ entity.name }}Model: SQLAlchemy model for {{ entity.table_name }} table

Related Docs:
- docs/{{ entity.capability }}/database/{{ entity.snake_name }}-model.md
"""

from sqlalchemy import Column, Integer, String, Boolean, Float, DateTime, Text, JSON, Numeric, Index
from sqlalchemy.orm import declarative_base
from datetime import datetime, UTC
from uuid import uuid4

Base = declarative_base()


class {{ entity.name }}Model(Base):
    """
    IDK: orm-model, {{ entity.snake_name }}, database-table

    Responsibility:
    - Map {{ entity.name }} to {{ entity.table_name }} table
    - Define column types and constraints
    - Support querying and persistence

    Invariants:
    - Table name is {{ entity.table_name }}
{% for field in entity.fields %}
    - {{ field.name }}: {{ field.field_type.value }}{% if field.required %}, required{% endif %}
{% endfor %}

    Related Docs:
    - docs/{{ entity.capability }}/database/{{ entity.snake_name }}-schema.md
    """

    __tablename__ = "{{ entity.table_name }}"

    # Primary key and base fields (inherited from Entity)
    id = Column(String(36), primary_key=True, default=lambda: str(uuid4()))
    code = Column(String(100), nullable=False)
    name = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    type = Column(String(50), nullable=True, default="{{ entity.snake_name }}")

    # Audit trail
    created_at = Column(DateTime(timezone=True), nullable=False, default=lambda: datetime.now(UTC))
    created_by = Column(String(255), nullable=True)
    updated_at = Column(DateTime(timezone=True), nullable=False, default=lambda: datetime.now(UTC), onupdate=lambda: datetime.now(UTC))
    updated_by = Column(String(255), nullable=True)

    # State management
    state = Column(Integer, nullable=False, default=1)
    status = Column(String(50), nullable=True)
    version = Column(Integer, nullable=False, default=1)

    # Multi-tenancy
    organization_id = Column(String(100), nullable=True)
    project_id = Column(String(100), nullable=True)
    owner = Column(String(255), nullable=True)

    # {{ entity.name }}-specific fields
{% set type_map = {
    'str': 'String',
    'int': 'Integer',
    'float': 'Float',
    'bool': 'Boolean',
    'datetime': 'DateTime',
    'uuid': 'String',
    'text': 'Text',
    'decimal': 'Numeric',
    'json': 'JSON'
} %}
{% for field in entity.fields %}
{% if field.field_type.value == 'str' %}
    {{ field.name }} = Column(String({{ field.max_length or 255 }}), nullable={{ not field.required }})
{% elif field.field_type.value == 'int' %}
    {{ field.name }} = Column(Integer, nullable={{ not field.required }})
{% elif field.field_type.value == 'float' %}
    {{ field.name }} = Column(Float, nullable={{ not field.required }})
{% elif field.field_type.value == 'bool' %}
    {{ field.name }} = Column(Boolean, nullable={{ not field.required }})
{% elif field.field_type.value == 'datetime' %}
    {{ field.name }} = Column(DateTime(timezone=True), nullable={{ not field.required }})
{% elif field.field_type.value == 'uuid' %}
    {{ field.name }} = Column(String(36), nullable={{ not field.required }})
{% elif field.field_type.value == 'text' %}
    {{ field.name }} = Column(Text, nullable={{ not field.required }})
{% elif field.field_type.value == 'decimal' %}
    {{ field.name }} = Column(Numeric(precision=10, scale=2), nullable={{ not field.required }})
{% elif field.field_type.value == 'json' %}
    {{ field.name }} = Column(JSON, nullable={{ not field.required }})
{% endif %}
{% endfor %}

{% set indexed_fields = entity.fields | selectattr('indexed', 'equalto', true) | list %}
{% if indexed_fields %}
    # Indexes
    __table_args__ = (
{% for field in indexed_fields %}
        Index('ix_{{ entity.table_name }}_{{ field.name }}', '{{ field.name }}'),
{% endfor %}
    )
{% endif %}
