"""
IDK: orm-model, {{ entity.snake_name }}, sqlalchemy, multi-tenant

Module: {{ entity.snake_name }}_model

Responsibility:
- Define SQLAlchemy ORM model for {{ entity.name }} with multi-tenant support
- Map domain entity to database table
- Define columns, indexes, and constraints
- Enforce organization_id for tenant isolation

Key Components:
- {{ entity.name }}Model: SQLAlchemy model for {{ entity.table_name }} table with multi-tenant fields

Related Docs:
- docs/{{ entity.capability }}/database/{{ entity.snake_name }}-model.md
"""

from sqlalchemy import Column, Integer, String, Boolean, Float, DateTime, Text, JSON, Numeric, Index
from sqlalchemy.orm import declarative_base
from datetime import datetime, UTC
from uuid import uuid4

Base = declarative_base()


class {{ entity.name }}Model(Base):
    """
    IDK: orm-model, {{ entity.snake_name }}, database-table, multi-tenant

    Responsibility:
    - Map {{ entity.name }} to {{ entity.table_name }} table
    - Define column types and constraints
    - Support querying and persistence
    - Enforce organization-level isolation

    Invariants:
    - Table name is {{ entity.table_name }}
    - organization_id is required and indexed for multi-tenant isolation
    - created_by is required for audit trail
{% for field in entity.fields %}
    - {{ field.name }}: {{ field.type }}{% if not field.nullable %}, required{% endif %}
{% endfor %}

    Related Docs:
    - docs/{{ entity.capability }}/database/{{ entity.snake_name }}-schema.md
    """

    __tablename__ = "{{ entity.table_name }}"

    # Primary key and base fields (inherited from Entity)
    id = Column(String(36), primary_key=True, default=lambda: str(uuid4()))
    code = Column(String(100), nullable=False)
    name = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    type = Column(String(50), nullable=True, default="{{ entity.snake_name }}")

    # Audit trail
    created_at = Column(DateTime(timezone=True), nullable=False, default=lambda: datetime.now(UTC))
    created_by = Column(String(255), nullable=False)  # Required for multi-tenant
    updated_at = Column(DateTime(timezone=True), nullable=False, default=lambda: datetime.now(UTC), onupdate=lambda: datetime.now(UTC))
    updated_by = Column(String(255), nullable=True)

    # State management
    state = Column(Integer, nullable=False, default=1)
    status = Column(String(50), nullable=True)
    version = Column(Integer, nullable=False, default=1)

    # Multi-tenancy (REQUIRED for authorized entities)
    organization_id = Column(String(100), nullable=False, index=True)  # Required and indexed
    project_id = Column(String(100), nullable=True)
    owner = Column(String(255), nullable=True)

    # {{ entity.name }}-specific fields
{% set type_map = {
    'str': 'String',
    'int': 'Integer',
    'float': 'Float',
    'bool': 'Boolean',
    'datetime': 'DateTime',
    'uuid': 'String',
    'text': 'Text',
    'decimal': 'Numeric',
    'json': 'JSON'
} %}
{% for field in entity.fields %}
{% if field.type == 'str' %}
    {{ field.name }} = Column(String({{ field.max_length or 255 }}), nullable={{ field.nullable }})
{% elif field.type == 'int' %}
    {{ field.name }} = Column(Integer, nullable={{ field.nullable }})
{% elif field.type == 'float' %}
    {{ field.name }} = Column(Float, nullable={{ field.nullable }})
{% elif field.type == 'bool' %}
    {{ field.name }} = Column(Boolean, nullable={{ field.nullable }})
{% elif field.type == 'datetime' %}
    {{ field.name }} = Column(DateTime(timezone=True), nullable={{ field.nullable }})
{% elif field.type == 'uuid' %}
    {{ field.name }} = Column(String(36), nullable={{ field.nullable }})
{% elif field.type == 'text' %}
    {{ field.name }} = Column(Text, nullable={{ field.nullable }})
{% elif field.type == 'decimal' %}
    {{ field.name }} = Column(Numeric(precision=10, scale=2), nullable={{ field.nullable }})
{% elif field.type == 'json' %}
    {{ field.name }} = Column(JSON, nullable={{ field.nullable }})
{% endif %}
{% endfor %}

{% set indexed_fields = entity.fields | selectattr('indexed', 'equalto', true) | list %}
    # Indexes
    __table_args__ = (
        # Multi-tenant indexes (critical for performance and security)
        Index('ix_{{ entity.table_name }}_organization_id', 'organization_id'),
        Index('ix_{{ entity.table_name }}_org_state', 'organization_id', 'state'),
{% if indexed_fields %}
        # Entity-specific indexes
{% for field in indexed_fields %}
        Index('ix_{{ entity.table_name }}_{{ field.name }}', '{{ field.name }}'),
        Index('ix_{{ entity.table_name }}_org_{{ field.name }}', 'organization_id', '{{ field.name }}'),
{% endfor %}
{% endif %}
    )
