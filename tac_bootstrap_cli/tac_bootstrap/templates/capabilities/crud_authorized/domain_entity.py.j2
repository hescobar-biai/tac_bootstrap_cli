"""
IDK: domain-entity, {{ entity.snake_name }}, business-logic, multi-tenant

Module: {{ entity.snake_name }}

Responsibility:
- Implement {{ entity.name }} domain entity with multi-tenant support
- Enforce business rules and invariants
- Provide domain-specific operations
- Include organization_id and created_by for authorization

Key Components:
- {{ entity.name }}: Domain entity with business logic and multi-tenant fields

Related Docs:
- docs/{{ entity.capability }}/domain/{{ entity.snake_name }}.md
"""

from pydantic import Field
{% set has_uuid = entity.fields | selectattr('field_type.value', 'equalto', 'uuid') | list | length > 0 %}
{% set has_datetime = entity.fields | selectattr('field_type.value', 'equalto', 'datetime') | list | length > 0 %}
{% set has_decimal = entity.fields | selectattr('field_type.value', 'equalto', 'decimal') | list | length > 0 %}
{% set has_json = entity.fields | selectattr('field_type.value', 'equalto', 'json') | list | length > 0 %}
{% if has_uuid %}
from uuid import UUID
{% endif %}
{% if has_datetime %}
from datetime import datetime
{% endif %}
{% if has_decimal %}
from decimal import Decimal
{% endif %}
{% if has_json %}
from typing import Dict, Any
{% endif %}
from {{ config.project.name | replace("-", "_") }}.shared.domain.base_entity import Entity


class {{ entity.name }}(Entity):
    """
    IDK: domain-entity, {{ entity.snake_name }}, aggregate-root, multi-tenant

    Responsibility:
    - Represent {{ entity.name }} domain entity
    - Enforce business rules and constraints
    - Provide domain operations
    - Maintain organization-level isolation

    Invariants:
    - Inherits all Entity invariants (id, audit trail, state management)
    - organization_id is required for multi-tenant isolation
    - created_by is required for audit trail
{% for field in entity.fields %}
    - {{ field.name }}: {{ 'required' if field.required else 'optional' }} {{ field.field_type.value }}
{% endfor %}

    Related Docs:
    - docs/{{ entity.capability }}/domain/{{ entity.snake_name }}.md
    """

    type: str = Field(
        default="{{ entity.snake_name }}",
        description="Entity type discriminator"
    )

{% set type_map = {
    'str': 'str',
    'int': 'int',
    'float': 'float',
    'bool': 'bool',
    'datetime': 'datetime',
    'uuid': 'UUID',
    'text': 'str',
    'decimal': 'Decimal',
    'json': 'Dict[str, Any]'
} %}
{% for field in entity.fields %}
    {{ field.name }}: {{ type_map[field.field_type.value] }}{% if not field.required %} | None{% endif %} = Field(
{% if not field.required %}
        default=None,
{% elif field.default is not none %}
        default={{ field.default }},
{% else %}
        ...,
{% endif %}
{% if field.max_length and field.field_type.value == 'str' %}
        max_length={{ field.max_length }},
{% endif %}
        description="{{ field.name | replace('_', ' ') | title }}"
    )
{% endfor %}

    def validate(self) -> None:
        """
        IDK: validation, business-rules, invariants

        Responsibility:
        - Validate business rules and constraints
        - Ensure entity integrity
        - Validate organization_id is set

        Invariants:
        - All business rules must pass
        - organization_id must be non-empty
        - Raises ValueError on validation failure

        Inputs:
        - None

        Outputs:
        - None (raises ValueError on failure)

        Related Docs:
        - docs/{{ entity.capability }}/domain/{{ entity.snake_name }}-validation.md
        """
        # Validate organization_id is set (critical for multi-tenant security)
        if not self.organization_id:
            raise ValueError("organization_id is required for multi-tenant entities")

        # TODO: Implement business validation rules
        pass

    def calculate_totals(self) -> None:
        """
        IDK: calculation, business-logic, derived-values

        Responsibility:
        - Calculate derived values and totals
        - Update computed fields

        Invariants:
        - Calculations are idempotent
        - Based on current entity state

        Inputs:
        - None

        Outputs:
        - None (mutates self)

        Related Docs:
        - docs/{{ entity.capability }}/domain/{{ entity.snake_name }}-calculations.md
        """
        # TODO: Implement business calculations
        pass
