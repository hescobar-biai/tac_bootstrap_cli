#!/bin/bash
# Setup an isolated worktree environment for {{ config.project.name }}
# Auto-generated by TAC Bootstrap
#
# Usage: ./scripts/setup_worktree.sh <worktree_path>

set -e

WORKTREE_PATH="$1"

if [ -z "$WORKTREE_PATH" ]; then
    echo "Usage: $0 <worktree_path>"
    exit 1
fi

if [ ! -d "$WORKTREE_PATH" ]; then
    echo "Error: Worktree directory does not exist: $WORKTREE_PATH"
    exit 1
fi

# Get the parent repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PARENT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Convert to absolute path
WORKTREE_PATH="$(cd "$WORKTREE_PATH" && pwd)"

echo "Setting up worktree: $WORKTREE_PATH"
echo "Parent repo: $PARENT_DIR"

# 1. Copy .env if exists in parent
if [ -f "$PARENT_DIR/.env" ]; then
    cp "$PARENT_DIR/.env" "$WORKTREE_PATH/.env"
    echo "  Copied .env"
else
    echo "  No .env in parent (skipping)"
fi

# 2. Create .mcp.json with absolute paths pointing to this worktree
cat > "$WORKTREE_PATH/.mcp.json" << EOF
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": [
        "@playwright/mcp@latest",
        "--isolated",
        "--config",
        "$WORKTREE_PATH/playwright-mcp-config.json"
      ]
    }
  }
}
EOF
echo "  Created .mcp.json"

# 3. Create playwright-mcp-config.json with absolute video path
mkdir -p "$WORKTREE_PATH/videos"
cat > "$WORKTREE_PATH/playwright-mcp-config.json" << EOF
{
  "browser": {
    "browserName": "chromium",
    "launchOptions": {
      "headless": true
    },
    "contextOptions": {
      "recordVideo": {
        "dir": "$WORKTREE_PATH/videos",
        "size": {
          "width": 1920,
          "height": 1080
        }
      },
      "viewport": {
        "width": 1920,
        "height": 1080
      }
    }
  }
}
EOF
echo "  Created playwright-mcp-config.json"
echo "  Created videos/ directory"

{% if config.project.framework in ["fastapi", "express", "next"] %}
# 4. Install backend dependencies
{% if config.project.language == "python" %}
if [ -f "$WORKTREE_PATH/{{ config.paths.app_root | default('app/server') }}/pyproject.toml" ]; then
    echo "  Installing backend dependencies..."
    (cd "$WORKTREE_PATH/{{ config.paths.app_root | default('app/server') }}" && {{ config.project.package_manager | default('uv') }} sync --all-extras)
    echo "  Backend dependencies installed"
fi
{% elif config.project.language == "typescript" %}
if [ -f "$WORKTREE_PATH/{{ config.paths.app_root | default('app/server') }}/package.json" ]; then
    echo "  Installing backend dependencies..."
    (cd "$WORKTREE_PATH/{{ config.paths.app_root | default('app/server') }}" && {{ config.project.package_manager | default('bun') }} install)
    echo "  Backend dependencies installed"
fi
{% endif %}

# 5. Install frontend dependencies
if [ -f "$WORKTREE_PATH/app/client/package.json" ]; then
    echo "  Installing frontend dependencies..."
    (cd "$WORKTREE_PATH/app/client" && {{ config.project.frontend_package_manager | default('bun') }} install)
    echo "  Frontend dependencies installed"
fi
{% endif %}

echo "Worktree setup complete: $WORKTREE_PATH"
