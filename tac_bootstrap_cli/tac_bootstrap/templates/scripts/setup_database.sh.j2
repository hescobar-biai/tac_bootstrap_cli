#!/bin/bash
# setup_database.sh - Initialize SQLite database for TAC-14 Orchestrator
#
# Usage:
#   ./{{ config.paths.scripts_dir }}/setup_database.sh              # Uses default path
#   ./{{ config.paths.scripts_dir }}/setup_database.sh custom.db    # Uses custom path

set -e

DB_PATH="${1:-{{ config.orchestrator.database_url | replace('sqlite:///', '') }}}"
SCHEMA_FILE="{{ config.paths.adws_dir }}/schema/schema_orchestrator.sql"

# Ensure data directory exists
mkdir -p "$(dirname "$DB_PATH")"

echo "Setting up SQLite database..."

# Check if schema file exists
if [ ! -f "$SCHEMA_FILE" ]; then
    echo "Error: Schema file not found: $SCHEMA_FILE"
    echo "Make sure you are running this from the project root directory."
    exit 1
fi

# Check if sqlite3 is available
if ! command -v sqlite3 &> /dev/null; then
    echo "Error: sqlite3 command not found."
    echo "Install SQLite: brew install sqlite (macOS) or apt install sqlite3 (Ubuntu)"
    exit 1
fi

# Warn if database already exists
if [ -f "$DB_PATH" ]; then
    echo "Warning: Existing database found at $DB_PATH"
    read -p "Overwrite? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
    rm "$DB_PATH"
fi

# Create new database and apply schema
echo "Creating database and applying schema..."
sqlite3 "$DB_PATH" < "$SCHEMA_FILE"

# Verify tables were created
TABLE_COUNT=$(sqlite3 "$DB_PATH" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';")
echo "Database initialized successfully: $DB_PATH"
echo "  Tables created: $TABLE_COUNT (orchestrator_agents, agents, prompts, agent_logs, system_logs)"
echo "  WAL mode: enabled"
echo "  Foreign keys: enabled"
