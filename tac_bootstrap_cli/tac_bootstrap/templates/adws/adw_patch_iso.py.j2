#!/usr/bin/env python3
"""Patch Workflow (Isolated).

Quick fix workflow: Build → Test → Ship
Skips planning phase for simple fixes.
"""
import argparse
import sys
import uuid
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

from adw_modules.state import ADWState
from adw_modules.git_ops import GitOps
from adw_modules.workflow_ops import WorkflowOps


def main():
    parser = argparse.ArgumentParser(description="Run patch workflow")
    parser.add_argument("--issue", type=int, required=True, help="Issue number")
    parser.add_argument("--fix", type=str, required=True, help="Fix description")
    args = parser.parse_args()

    state = ADWState(
        adw_id=uuid.uuid4().hex[:8],
        issue_number=args.issue,
        issue_class="patch",
    )
    state.save()

    print(f"Patch ADW ID: {state.adw_id}")

    # Setup worktree
    git = GitOps()
    worktree_path = Path("{{ config.paths.worktrees_dir }}") / state.adw_id
    branch_name = f"patch-{state.adw_id}"

    git.create_worktree(worktree_path, branch_name)
    state.worktree_path = str(worktree_path)
    state.branch_name = branch_name
    state.save()

    ops = WorkflowOps(state, cwd=worktree_path)

    # Direct implementation (no planning)
    print("Implementing patch...")
    from adw_modules.agent import run_claude_command
    result = run_claude_command("patch", args.fix, cwd=worktree_path)

    if not result["success"]:
        print("Patch failed")
        sys.exit(1)

    # Test
    print("Testing...")
    if not ops.test():
        print("Tests failed")
        sys.exit(1)

    # Ship
    print("Shipping...")
    if not ops.ship():
        print("Ship failed")
        sys.exit(1)

    print(f"Patch completed: {state.adw_id}")


if __name__ == "__main__":
    main()
